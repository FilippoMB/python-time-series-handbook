
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Neural networks and Reservoir Computing &#8212; Time series analysis with Python</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/10/nn-reservoir-computing';</script>
    <link rel="icon" href="../../_static/logo.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Nonlinear time series analysis" href="../11/nonlinear-ts.html" />
    <link rel="prev" title="Prophet" href="../09/prophet.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../00/intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Time series analysis with Python - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Time series analysis with Python - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../00/intro.html">
                    Time series analysis with Python
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01/introduction_to_time_series.html">Introduction to time series analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02/stationarity.html">Stationarity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03/smoothing.html">Smoothing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04/ar-ma.html">AR-MA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05/arma_arima_sarima.html">ARMA, ARIMA, SARIMA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../06/unit-root-hurst.html">Unit root test and Hurst exponent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../07/kalman-filter.html">Kalman filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../08/signal-transforms-filters.html">Signal transforms and filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09/prophet.html">Prophet</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Neural networks and Reservoir Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11/nonlinear-ts.html">Nonlinear time series analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../12/classification-clustering.html">Time series classification and clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00/knowledge_test.html">Knowledge test</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00/resources.html">Resources and acknowledgments</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/FilippoMB/python-time-series-handbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/FilippoMB/python-time-series-handbook/issues/new?title=Issue%20on%20page%20%2Fnotebooks/10/nn-reservoir-computing.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/10/nn-reservoir-computing.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Neural networks and Reservoir Computing</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#windowed-approaches-for-prediction">Windowed approaches for prediction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#limitation-of-linear-models">Limitation of linear models</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-forecasting-electricity-demand">Example: forecasting electricity demand</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advantages-of-nonlinear-models">Advantages of Nonlinear Models</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#neural-networks">Neural networks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-layer-perceptron">Multi-Layer Perceptron</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-a-simple-mlp">Example: a simple MLP</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlp-for-time-series-forecasting">MLP for time series forecasting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#python-example">Python example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#windowed-approaches-drawbacks">Windowed approaches drawbacks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recurrent-neural-networks">Recurrent Neural Networks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#challenges-and-shortcomings-in-rnns">Challenges and shortcomings in RNNs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reservoir-computing">Reservoir Computing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#readout">Readout</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-the-reservoir-approach-works">Why the Reservoir approach works</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reservoir-configuration">Reservoir configuration</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spectral-radius">Spectral radius</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#input-scaling">Input scaling</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#python-example-electricity-load-forecasting-with-esn">Python example: electricity load forecasting with ESN</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-data">Load the data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-the-reservoir-and-compute-the-states">Define the Reservoir and compute the states</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-a-linear-readout">Fit a linear readout</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reducing-the-dimensionality-of-the-reservoir-states">Reducing the dimensionality of the Reservoir states</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#principal-component-analysis-pca">Principal Component Analysis (PCA)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Reducing the dimensionality of the Reservoir states</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-a-gbrt-readout">Fit a GBRT readout</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1">Exercise 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2">Exercise 2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3">Exercise 3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4">Exercise 4</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="neural-networks-and-reservoir-computing">
<h1>Neural networks and Reservoir Computing<a class="headerlink" href="#neural-networks-and-reservoir-computing" title="Link to this heading">#</a></h1>
<img alt="../../_images/cover9.png" src="../../_images/cover9.png" />
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>In this lecture we will cover the following topics:</p>
<ul class="simple">
<li><p>Windowed approaches and nonlinear models for time series forecasting.</p></li>
<li><p>Neural networks and the Multi-Layer Perceptron.</p></li>
<li><p>A brief overview of Recurrent Neural Networks.</p></li>
<li><p>The ESN, a randomized RNN from the family of Reservoir Computing.</p></li>
<li><p>An introduction to dimensionality reduction with Principal Component Analysis.</p></li>
<li><p>Examples of forecasting with MLP and ESN on real-world electricity data.</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="c1"># Install dependencies if the notebook is running in Colab</span>
<span class="k">if</span> <span class="s1">&#39;google.colab&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
    <span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>-U<span class="w"> </span>-qq<span class="w"> </span>reservoir_computing
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_circles</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neural_network</span><span class="w"> </span><span class="kn">import</span> <span class="n">MLPRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_blobs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ridge</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">HistGradientBoostingRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">reservoir_computing.reservoir</span><span class="w"> </span><span class="kn">import</span> <span class="n">Reservoir</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">reservoir_computing.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_forecasting_dataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">reservoir_computing.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">PredLoader</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<hr class="docutils" />
<section id="windowed-approaches-for-prediction">
<h2>Windowed approaches for prediction<a class="headerlink" href="#windowed-approaches-for-prediction" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>These methods consider a fixed window of size <span class="math notranslate nohighlight">\(P\)</span>.</p></li>
<li><p>Use the elements of the time series within the window <span class="math notranslate nohighlight">\(x(t-P), \dots, x(t-1), x(t)\)</span> to compute the prediction <span class="math notranslate nohighlight">\(x(t+\tau)\)</span>, where <span class="math notranslate nohighlight">\(\tau\)</span> is the forecasting horizon.</p></li>
<li><p>Different algorithms combine the elements of the window in different ways to make predictions.</p></li>
</ul>
<img alt="../../_images/windowed.png" src="../../_images/windowed.png" />
<ul class="simple">
<li><p>As the window slides along the time series, new predictions are made.</p></li>
<li><p>An example of windowed approach is the linear AR model of order <span class="math notranslate nohighlight">\(P\)</span>:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\hat y(t+1) = \beta_0 + \beta_1 x(t-1) + \beta_2 x(t-2) + \dots + \beta_P x(t-P)+\epsilon_t\]</div>
<img alt="../../_images/sin.gif" src="../../_images/sin.gif" />
<section id="limitation-of-linear-models">
<h3>Limitation of linear models<a class="headerlink" href="#limitation-of-linear-models" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Linear models are widely used for their simplicity and interpretiveness.</p></li>
<li><p>However, they assume a constant relationship between input and target variables.</p></li>
<li><p>As such, they cannot capture these nonlinearities and interactions effectively.</p></li>
</ul>
<ul class="simple">
<li><p>Consider the following examples:</p>
<ol class="arabic simple">
<li><p>Compute the <em>position</em> <span class="math notranslate nohighlight">\(y\)</span> of a robotic arm given the positions <span class="math notranslate nohighlight">\(x_1, x_2, \dots\)</span> of the joints.</p></li>
<li><p>Compute a trajectory <span class="math notranslate nohighlight">\(\dot{y}\)</span> given the angular velocities <span class="math notranslate nohighlight">\(\omega_1, \omega_2, \dots\)</span> of the joints.</p></li>
</ol>
</li>
</ul>
<img alt="../../_images/robot.png" src="../../_images/robot.png" />
<ul class="simple">
<li><p>A linear model will fail in the second task.</p></li>
</ul>
<section id="example-forecasting-electricity-demand">
<h4>Example: forecasting electricity demand<a class="headerlink" href="#example-forecasting-electricity-demand" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>This is a classic example where linear models fail.</p></li>
<li><p>Electricity demand is often governed by complex and nonlinear interactions with other factors.</p></li>
</ul>
<p><strong>Temperature and Demand</strong></p>
<ul class="simple">
<li><p>The relationship between temperature and electricity demand is typically nonlinear and can exhibit a U-shaped curve.</p></li>
<li><p>Demand is low at moderate temperatures but increases sharply at high or low temperatures due to heating and cooling needs.</p></li>
</ul>
<p><strong>Time and Demand</strong></p>
<ul class="simple">
<li><p>Demand patterns vary significantly throughout:</p>
<ul>
<li><p>the day (peak hours in the morning and evening),</p></li>
<li><p>week (workdays vs. weekends),</p></li>
<li><p>year (summer vs. winter).</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="advantages-of-nonlinear-models">
<h3>Advantages of Nonlinear Models<a class="headerlink" href="#advantages-of-nonlinear-models" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Nonlinear models, such as neural networks, SVM, tree-based methods, etc…, can:</p>
<ul>
<li><p>model the nonlinear relationships between demand and factors like temperature, capturing the U-shaped curve accurately,</p></li>
<li><p>take into account the interactions between different variables, such as the combined effect of time, holidays, and temperature on demand,</p></li>
<li><p>adapt to various patterns and changes in trends over time, making them more robust in dynamic environments.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="neural-networks">
<h2>Neural networks<a class="headerlink" href="#neural-networks" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Neural Nets are powerful nonlinear models that are <em>universal approximators</em>, i.e., they can learn to approximate any function.</p></li>
<li><p>Basic idea:</p>
<ol class="arabic simple">
<li><p>Map the data into a high dimensional space (bless of dimensionality).</p></li>
<li><p>Apply a nonlinear transformation.</p></li>
<li><p>Data become linearly separable.</p></li>
</ol>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_3D</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_circles</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">.01</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mf">.15</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">X</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter3D</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="n">elev</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="n">azim</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
    <span class="n">zz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$z_1$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$z_2$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;$z_3$&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(())</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(())</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_zticks</span><span class="p">(())</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$x_1$&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$x_2$&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(())</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(())</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<ul class="simple">
<li><p>This figure illustrates how mapping the data from a lower dimension (2D) to a higher dimension (3D) and applying a nonlinear function makes data linearly separable by an hyperplane.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_3D</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/50bd9c9bb648c4a355b14c04128238c405bb86046302c135cf7df7deefb206db.png" src="../../_images/50bd9c9bb648c4a355b14c04128238c405bb86046302c135cf7df7deefb206db.png" />
</div>
</div>
<section id="multi-layer-perceptron">
<h3>Multi-Layer Perceptron<a class="headerlink" href="#multi-layer-perceptron" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>A Multi-Layer Perceptron (MLP) is a simple Neural Network that consists of at least three layers of nodes:</p>
<ul>
<li><p>An input layer.</p></li>
<li><p>One or more hidden layers.</p></li>
<li><p>An output layer.</p></li>
</ul>
</li>
<li><p>The nodes in the a hidden layers apply a nonlinear activation function <span class="math notranslate nohighlight">\(\sigma\)</span>.</p></li>
<li><p>MLP are generally trained with a supervised learing technique called backpropagation.</p></li>
</ul>
<ul class="simple">
<li><p>The MLP’s layers are fully connected, meaning each node in one layer connects with a certain weight to every node in the following layer.</p></li>
<li><p>The first layer receives the input.</p></li>
<li><p>The output of each layer is the input for the next layer until the final layer produces the output of the MLP.</p></li>
<li><p>The weights are stored in matrices <span class="math notranslate nohighlight">\(W\)</span> and are the trainable parameters of the model.</p></li>
<li><p>The MLP can learn complex mappings from inputs to outputs to perform a wide range of data modeling and prediction tasks.</p></li>
</ul>
<section id="example-a-simple-mlp">
<h4>Example: a simple MLP<a class="headerlink" href="#example-a-simple-mlp" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Let’s consider a concrete example of an MLP with one input layer, two hidden layers (with <span class="math notranslate nohighlight">\(h_1\)</span> and <span class="math notranslate nohighlight">\(h_2\)</span> units respectively), and one output layer.</p></li>
<li><p>The input vectors are of size <span class="math notranslate nohighlight">\(d_\text{in}\)</span>, and the output vectors are of size <span class="math notranslate nohighlight">\(d_\text{out}\)</span>.</p></li>
</ul>
<img alt="../../_images/mlp.png" src="../../_images/mlp.png" />
<p><strong>Input layer</strong></p>
<ul class="simple">
<li><p>The size of the input layer corresponds to the size of the input vectors, <span class="math notranslate nohighlight">\(d_\text{in}\)</span>.</p></li>
<li><p>This layer simply passes the input to the first hidden layer without applying any transformation.</p></li>
</ul>
<p><strong>First hidden layer</strong></p>
<ul class="simple">
<li><p>This layer has <span class="math notranslate nohighlight">\(h_1\)</span> nodes.</p></li>
<li><p>Each node connects to all the <span class="math notranslate nohighlight">\(d_{\text{in}}\)</span> inputs.</p></li>
<li><p>It applies a weight matrix <span class="math notranslate nohighlight">\(W_\text{in} \in \mathbb{R}^{d_\text{in} \times h_1}\)</span> that transforms the input from vectors in <span class="math notranslate nohighlight">\(\mathbb{R}^{d_\text{in}}\)</span> to vectors in <span class="math notranslate nohighlight">\(\mathbb{R}^{h_1}\)</span>.</p></li>
<li><p>Then, it applies a nonlinear activation function <span class="math notranslate nohighlight">\(\sigma\)</span>, and outputs <span class="math notranslate nohighlight">\(h_1\)</span> intermediate results.</p></li>
</ul>
<p><strong>Second hidden layer</strong></p>
<ul class="simple">
<li><p>This layer has <span class="math notranslate nohighlight">\(h_2\)</span> nodes.</p></li>
<li><p>It takes the <span class="math notranslate nohighlight">\(h_1\)</span> outputs from the first hidden layer.</p></li>
<li><p>It applies another set of weights and a nonlinear activation function to produce <span class="math notranslate nohighlight">\(h_2\)</span> intermediate results.</p></li>
</ul>
<p><strong>Output Layer</strong></p>
<ul class="simple">
<li><p>The output layer has <span class="math notranslate nohighlight">\(d_\text{out}\)</span> units.</p></li>
<li><p>It takes the <span class="math notranslate nohighlight">\(h_2\)</span> outputs from the second hidden layer, applies weights and possibly a different activation function that depends on the task (usually, softmax for classification or no activation for regression).</p></li>
<li><p>The final output vector is of size <span class="math notranslate nohighlight">\(d_\text{out}\)</span>.</p></li>
</ul>
</section>
</section>
<section id="mlp-for-time-series-forecasting">
<h3>MLP for time series forecasting<a class="headerlink" href="#mlp-for-time-series-forecasting" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The MLP can be used as a windowed technique to perform time series forecasting.</p></li>
<li><p>The sequence of past values <span class="math notranslate nohighlight">\(x(t-P), \dots, x(t-1), x(t)\)</span> will represent our input vector (<span class="math notranslate nohighlight">\(d_\text{in} = P\)</span>).</p></li>
<li><p>The future value <span class="math notranslate nohighlight">\(x(t+\tau)\)</span> will be the output that the model will learn to predict (<span class="math notranslate nohighlight">\(d_\text{out} = 1\)</span>).</p></li>
<li><p>We can also train the MLP to predict a sequence of <span class="math notranslate nohighlight">\(d_\text{out} = H\)</span> future predictions, e.g., <span class="math notranslate nohighlight">\(x(t+\tau), x(t+\tau+1), \dots, x(t+\tau+H)\)</span>.</p></li>
</ul>
<img alt="../../_images/mlp_windowed.png" src="../../_images/mlp_windowed.png" />
<ul class="simple">
<li><p>Key for the training of the MLP is the creation of input-output pairs <span class="math notranslate nohighlight">\(\{\mathbf{x}_i, \mathbf{y}_i\}\)</span> used for training.</p></li>
<li><p>Given the input <span class="math notranslate nohighlight">\(\mathbf{x}_i\)</span> the model must learn to predict the output <span class="math notranslate nohighlight">\(\mathbf{y}_i\)</span>.</p></li>
<li><p>This is done by adapting the model weights to minimize the discrepancy between the prediction <span class="math notranslate nohighlight">\(\mathbf{\hat y}_i\)</span> and the desired output <span class="math notranslate nohighlight">\(\mathbf{y}_i\)</span>.</p></li>
<li><p>The weights are modified according to the gradient taken with respect to a loss function <span class="math notranslate nohighlight">\(\mathcal{L}(\mathbf{\hat y}_i, \mathbf{y}_i)\)</span> such as the MSE, e.g., <span class="math notranslate nohighlight">\(W \leftarrow W + \delta \frac{\partial \mathcal{L}}{\partial W}\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\delta\)</span> is a small constant defining the gradient step (learning rate).</p></li>
</ul>
<ul class="simple">
<li><p>Given the chunk of time series used for training, the training samples are generated according to the scheme in the picture.</p></li>
<li><p>Each input-output pair consists of:</p>
<ul>
<li><p>a window of past time series values <span class="math notranslate nohighlight">\(x(t-P), \dots, x(t-1), x(t)\)</span>.</p></li>
<li><p>a window of future values <span class="math notranslate nohighlight">\(x(t+\tau), x(t+\tau+1) \dots, x(t+\tau+H)\)</span>.</p></li>
</ul>
</li>
</ul>
<img alt="../../_images/data_split.png" src="../../_images/data_split.png" />
</section>
<section id="python-example">
<h3>Python example<a class="headerlink" href="#python-example" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>In this example we will consider a time series of electricity consumption registered on a backbone of the energy distribution network of Rome.</p></li>
<li><p>The original time series has 10min resolution.</p></li>
<li><p>For this example, we will resample it to 1h resolution as it will become more smooth (and easier to predict).</p></li>
<li><p>To train our models faster, we will consider only the first <code class="docutils literal notranslate"><span class="pre">3000</span></code> samples.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts_full</span> <span class="o">=</span> <span class="n">PredLoader</span><span class="p">()</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;ElecRome&#39;</span><span class="p">)</span>

<span class="c1"># Resample the time series to hourly frequency</span>
<span class="n">ts_hourly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ts_full</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Use only the first 3000 time steps</span>
<span class="n">time_series</span> <span class="o">=</span> <span class="n">ts_hourly</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3000</span><span class="p">]</span>
<span class="n">time_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_series</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loaded ElecRome dataset.
Data shape:
  X: (137376, 1)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Next we split the data in train and test set.</p></li>
<li><p>We simply use the first 90% as training and the rest as test.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split the time series into training and test sets</span>
<span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.9</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">time_series</span><span class="p">))</span>
<span class="n">tr</span> <span class="o">=</span> <span class="n">time_series</span><span class="p">[:</span><span class="n">train_size</span><span class="p">]</span>
<span class="n">te</span> <span class="o">=</span> <span class="n">time_series</span><span class="p">[</span><span class="n">train_size</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Next, we define the function to create input-output pairs.</p></li>
<li><p>For example, we create as input windows of size <span class="math notranslate nohighlight">\(P=12\)</span> by specifying <code class="docutils literal notranslate"><span class="pre">window_size=12</span></code>.</p></li>
<li><p>Similarly, we create as ouput windows of size <code class="docutils literal notranslate"><span class="pre">forecast_horizon=12</span></code>.</p></li>
<li><p>If we are interested in predicting only one sample, e.g., <span class="math notranslate nohighlight">\(\tau=12\)</span> and <span class="math notranslate nohighlight">\(H=1\)</span>, we simply take the last element of the output window.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_windows</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="p">):</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">-</span> <span class="n">forecast_horizon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="n">window_size</span><span class="p">)])</span>
        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">window_size</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">window_size</span> <span class="o">+</span> <span class="n">forecast_horizon</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Define window size and forecast horizon</span>
<span class="n">window_size</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">forecast_horizon</span> <span class="o">=</span> <span class="mi">12</span>

<span class="c1"># Create input-output pairs</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">create_windows</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="p">)</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">create_windows</span><span class="p">(</span><span class="n">te</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>We can see how the input-output pairs look like in the following plot.</p></li>
<li><p>The blue dots will represent the input <span class="math notranslate nohighlight">\(x_{t-P}, \dots x_{t-1}, x_t\)</span> with <span class="math notranslate nohighlight">\(P=12\)</span>.</p></li>
<li><p>The orange dot is the output <span class="math notranslate nohighlight">\(x_{t+\tau}\)</span> with <span class="math notranslate nohighlight">\(\tau=12\)</span>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot some pairs of input-output</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">window_size</span><span class="o">+</span><span class="n">i</span><span class="p">),</span> <span class="n">X_train</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># Input</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">window_size</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">window_size</span><span class="o">+</span><span class="n">forecast_horizon</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_train</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span> 
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">window_size</span><span class="o">+</span><span class="n">forecast_horizon</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_train</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:orange&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time step&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/ecd98e1f9f4afad394d910e63d9acffb95e6c6943b5685d44d4b53e43fdc389f.png" src="../../_images/ecd98e1f9f4afad394d910e63d9acffb95e6c6943b5685d44d4b53e43fdc389f.png" />
</div>
</div>
<ul class="simple">
<li><p>Let say we instead want to predict the energy consumption 1 day ahead by looking at the consumption of the previous 12 hours, which is a more realisitc scenario.</p></li>
<li><p>We define <code class="docutils literal notranslate"><span class="pre">forecast_horizon</span> <span class="pre">=</span> <span class="pre">24</span></code> to do that.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define window size and forecast horizon</span>
<span class="n">window_size</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">forecast_horizon</span> <span class="o">=</span> <span class="mi">24</span>

<span class="c1"># Create input-output pairs</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">create_windows</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="p">)</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">create_windows</span><span class="p">(</span><span class="n">te</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">forecast_horizon</span><span class="p">)</span>

<span class="c1"># We are only interested in the last time step of the horizon</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>  
<span class="n">y_test</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Most neural nets, including the MLP, want the data to be normalized in a small range.</p></li>
<li><p>We can do that by applying the <code class="docutils literal notranslate"><span class="pre">StandardScaler()</span></code> from the sklearn library.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scaler.fit_transform(X_train)</span></code> will subtract from <code class="docutils literal notranslate"><span class="pre">X_train</span></code> its mean and divide by its variance.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">scaler.transform(X_test)</span></code> will subtract from <code class="docutils literal notranslate"><span class="pre">X_test</span></code> the mean of <code class="docutils literal notranslate"><span class="pre">X_train</span></code> and divide by the variance of <code class="docutils literal notranslate"><span class="pre">X_train</span></code>.</p></li>
<li><p>Why not normalizing with the test set statistics?</p>
<ul>
<li><p>Because we do not have access to the test data beforehand, so we cannot compute statistics such as its mean and variance.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Normalize the data</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Next, we define the MLP.</p></li>
<li><p>We specify the size of the hidden layers as <span class="math notranslate nohighlight">\(h_1=16\)</span> and <span class="math notranslate nohighlight">\(h_2=8\)</span>. Using larger values increases the model capacity, but can lead to overfit.</p></li>
<li><p>As the activation function we use a <a class="reference external" href="https://en.wikipedia.org/wiki/Rectifier_(neural_networks)">ReLU</a>.</p></li>
<li><p>As the algorithms to compute the gradients and update the values of the parameters <span class="math notranslate nohighlight">\(W\)</span> we use <a class="reference external" href="https://en.wikipedia.org/wiki/Stochastic_gradient_descent#Adam">Adam</a>.</p></li>
<li><p>Finally, we train the model for <code class="docutils literal notranslate"><span class="pre">1000</span></code> iterations.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define and train the neural network</span>
<span class="n">mlp</span> <span class="o">=</span> <span class="n">MLPRegressor</span><span class="p">(</span><span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">mlp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>#sk-container-id-1 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: #000;
  --sklearn-color-text-muted: #666;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-1 {
  color: var(--sklearn-color-text);
}

#sk-container-id-1 pre {
  padding: 0;
}

#sk-container-id-1 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-1 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-1 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-1 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-1 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-1 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-1 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-1 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-1 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-1 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-1 label.sk-toggleable__label {
  cursor: pointer;
  display: flex;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
  align-items: start;
  justify-content: space-between;
  gap: 0.5em;
}

#sk-container-id-1 label.sk-toggleable__label .caption {
  font-size: 0.6rem;
  font-weight: lighter;
  color: var(--sklearn-color-text-muted);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-1 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-1 div.sk-label label.sk-toggleable__label,
#sk-container-id-1 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-1 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-1 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-1 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-1 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-1 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 0.5em;
  text-align: center;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-1 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-1 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-1 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-1 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>MLPRegressor(hidden_layer_sizes=(16, 8), max_iter=1000)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked><label for="sk-estimator-id-1" class="sk-toggleable__label fitted sk-toggleable__label-arrow"><div><div>MLPRegressor</div></div><div><a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.6/modules/generated/sklearn.neural_network.MLPRegressor.html">?<span>Documentation for MLPRegressor</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></div></label><div class="sk-toggleable__content fitted"><pre>MLPRegressor(hidden_layer_sizes=(16, 8), max_iter=1000)</pre></div> </div></div></div></div></div></div>
</div>
<ul class="simple">
<li><p>Once the model is trained, we can compute the prediction on the test set.</p></li>
<li><p>We can also compute predictions beyond the whole dataset that we have available.</p></li>
<li><p>In this case, we do not have a way to check how well the model is doing since we do not have the actual data available.</p></li>
<li><p>However, it reflects a realistic forecasting scenario where we, indeed, do not know the future.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Predict on the test set</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>

<span class="c1"># Forecast beyond the dataset using the model</span>
<span class="n">last_window</span> <span class="o">=</span> <span class="n">time_series</span><span class="p">[</span><span class="o">-</span><span class="n">window_size</span><span class="p">:]</span>
<span class="n">last_window_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">last_window</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">next_step_pred</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">last_window_scaled</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The next time step prediction is </span><span class="si">{</span><span class="n">next_step_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The next time step prediction is 32.27
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>To check the performance of the model we can compute the MSE on the predictions of the test set.</p></li>
<li><p>We can also visualize the predictions against the real data.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean Squared Error: </span><span class="si">{</span><span class="n">mse</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_steps</span><span class="p">[</span><span class="mi">2500</span><span class="p">:],</span> <span class="n">time_series</span><span class="p">[</span><span class="mi">2500</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Actual&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_steps</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">):],</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Time Series Forecast&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time Step&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mean Squared Error: 26.18
</pre></div>
</div>
<img alt="../../_images/99104ac5c7a06085d98d6542929145a92acf5e44ba44308935b876f176070109.png" src="../../_images/99104ac5c7a06085d98d6542929145a92acf5e44ba44308935b876f176070109.png" />
</div>
</div>
<ul class="simple">
<li><p>Is the prediction good or not?</p></li>
<li><p>To get an idea, we can compare the performance against a simple baseline.</p></li>
<li><p>In this case, we are making a prediction at a forecast horizon <span class="math notranslate nohighlight">\(\tau=24\)</span> equal to the main seasonality of the time series.</p></li>
<li><p>The most natural baseline is to use the values of the previous day as the prediction for the next day.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the mse between the original time series and the time series shifhted by 24 time steps</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">[</span><span class="mi">24</span><span class="p">:],</span> <span class="n">y_test</span><span class="p">[:</span><span class="o">-</span><span class="mi">24</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean Squared Error: </span><span class="si">{</span><span class="n">mse</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_test</span><span class="p">[</span><span class="mi">24</span><span class="p">:])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_test</span><span class="p">[:</span><span class="o">-</span><span class="mi">24</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mean Squared Error: 27.14
</pre></div>
</div>
<img alt="../../_images/e15dd7781b8298dec7db848d8474cfb4560e4ca0f9114d1b9b546f55d514f5ec.png" src="../../_images/e15dd7781b8298dec7db848d8474cfb4560e4ca0f9114d1b9b546f55d514f5ec.png" />
</div>
</div>
<ul class="simple">
<li><p>Any reasonable forecasting method must beat this baseline.</p></li>
</ul>
</section>
<section id="windowed-approaches-drawbacks">
<h3>Windowed approaches drawbacks<a class="headerlink" href="#windowed-approaches-drawbacks" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>What is the optimal value of <span class="math notranslate nohighlight">\(P\)</span>?</p></li>
<li><p>If <span class="math notranslate nohighlight">\(P\)</span> is fixed, how can we deal with different temporal dependencies?</p></li>
<li><p>Let’s consider the example of predicting the next word in a sentence.</p></li>
</ul>
<img alt="../../_images/word_pred.gif" src="../../_images/word_pred.gif" />
<ul class="simple">
<li><p>In the first case, we need to go back 4 time steps to retrieve the information we need.</p></li>
<li><p>In the second case, 9 steps.</p></li>
<li><p>How to set <span class="math notranslate nohighlight">\(P\)</span>? What is the maximum memory we will ever need?</p></li>
<li><p>As discussed previously, setting <span class="math notranslate nohighlight">\(P\)</span> too high will smooth our data too much.</p></li>
<li><p>Finding a good tradeoff is difficult…</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="recurrent-neural-networks">
<h2>Recurrent Neural Networks<a class="headerlink" href="#recurrent-neural-networks" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>RNNs are a class of neural networks designed to recognize patterns in sequences of data, such as time series data, natural language, or sequences of images.</p></li>
<li><p>Unlike traditional neural networks, RNNs have a memory that captures information about what has been calculated so far, essentially allowing them to make predictions based on past inputs.</p></li>
</ul>
<ul class="simple">
<li><p>As an RNN processes a sequence <span class="math notranslate nohighlight">\(\mathbf{x}\)</span> it maintains information in a <em>hidden state</em> <span class="math notranslate nohighlight">\(\mathbf{h}\)</span>.</p></li>
<li><p>This process allows the RNN to use previous computations as a context for making decisions about new data.</p></li>
</ul>
<img alt="../../_images/RNN.gif" src="../../_images/RNN.gif" />
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(x(t)\)</span> is the input time series, <span class="math notranslate nohighlight">\(\mathbf{h}(t)\)</span> the hidden state vector, <span class="math notranslate nohighlight">\(y(t)\)</span> the output.</p></li>
<li><p>The matrices <span class="math notranslate nohighlight">\(W_x\)</span>, <span class="math notranslate nohighlight">\(W_h\)</span>, and <span class="math notranslate nohighlight">\(W_o\)</span> represents the input, hidden (recurrent), and output weights respectively.</p></li>
</ul>
<p><strong>Back Propagation Through Time (BPTT)</strong></p>
<ul class="simple">
<li><p>BPTT is the algorithm used for training RNNs.</p></li>
<li><p>It involves unfolding the RNN through time to obtain a standard feed-forward neural network (like an MLP).</p></li>
<li><p>After unfolding, one can apply the standard backpropagation algorithm.</p></li>
<li><p>BPTT computes gradients for each parameter across <em>all</em> time steps of the input sequence.</p></li>
</ul>
<img alt="../../_images/bptt.png" src="../../_images/bptt.png" />
<section id="challenges-and-shortcomings-in-rnns">
<h3>Challenges and shortcomings in RNNs<a class="headerlink" href="#challenges-and-shortcomings-in-rnns" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>In BPTT the gradient has to go through all time steps and, due to the presence of nonlinearities, it can become too small and not reach distant time steps.</p></li>
<li><p>This creates the problem called <em>vanishing gradient</em>.</p></li>
<li><p>Opposed, yet similar, is the problem of <em>exploding gradient</em> occurring when the gradients grow across the sequence.</p></li>
<li><p>The vanishing gradient problem makes it hard for RNNs to learn long-range dependencies because updates to the weights become insignificantly small, causing the learning to stall.</p></li>
<li><p>Conversely, exploding gradients can cause weights to oscillate or diverge.</p></li>
<li><p>Techniques such as gradient clipping and gated units (e.g., LSTM, GRU) have been developed to mitigate these issues.</p></li>
</ul>
<ul class="simple">
<li><p>Another important limitation of the RNNs is that they fail to exploit hardware acceleration like other neural nets.</p></li>
<li><p>This is due to their recurrent nature that requires computations to be done sequentially rather than in parallel.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="reservoir-computing">
<h2>Reservoir Computing<a class="headerlink" href="#reservoir-computing" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>RC is a familily of randomized RNNs, popularized in machine learning by Echo State Networks (ESNs).</p></li>
<li><p>RC and ESNs are terms ofen used interchangeably.</p></li>
<li><p>There are two main differences that separate an ESN from an RNN:</p></li>
</ul>
<img alt="../../_images/Reservoir.gif" src="../../_images/Reservoir.gif" />
<ul class="simple">
<li><p>The output weights <span class="math notranslate nohighlight">\(W_o\)</span> is the only part of the ESN that is trained.</p></li>
<li><p>Optimizing <span class="math notranslate nohighlight">\(W_o\)</span> can be done with a simple linear regression algorithm.</p></li>
<li><p>The workflow is the following.</p></li>
</ul>
<ol class="arabic">
<li><p>Generate a sequence of reservoir states <span class="math notranslate nohighlight">\(\mathbf{H} = \{\mathbf{h}(0), \mathbf{h}(1), \dots, \mathbf{h}(T)\}\)</span>.</p>
<ul class="simple">
<li><p>This is done by applying the state update equation</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\mathbf{h}_t = \sigma \left(\mathbf{W}_i x(t)+\mathbf{W}_h \mathbf{h}(t-1)\right)\]</div>
<ul class="simple">
<li><p>for each time step <span class="math notranslate nohighlight">\(t=1,2, \dots, T\)</span> of the input sequence.</p></li>
<li><p>The nonlinearity <span class="math notranslate nohighlight">\(\sigma\)</span> is usually an hyperbolic tangent (<span class="math notranslate nohighlight">\(\texttt{tanh}\)</span>).</p></li>
</ul>
</li>
</ol>
<ol class="arabic simple" start="2">
<li><p>Apply a linear regression algorithm to compute a linear mapping <span class="math notranslate nohighlight">\(g(\cdot)\)</span> between the reservoir states and the desired output sequence <span class="math notranslate nohighlight">\(\mathbf{y} = \{y(1), y(2), \dots, y(T) \}\)</span>:</p></li>
</ol>
<div class="math notranslate nohighlight">
\[\mathbf{y} = g(\mathbf{H})\]</div>
<ul class="simple">
<li><p>The function <span class="math notranslate nohighlight">\(g(\cdot)\)</span> is called <em>readout</em>.</p></li>
<li><p>In a forecasting setting, <span class="math notranslate nohighlight">\(y(t)\)</span> correspond to a future value of the input, e.g., <span class="math notranslate nohighlight">\(y(t) = x(t+\tau)\)</span>.</p></li>
</ul>
<section id="readout">
<h3>Readout<a class="headerlink" href="#readout" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The readout <span class="math notranslate nohighlight">\(g(\cdot)\)</span> is usually implemented through a linear regression model, e.g., Ridge Regression.</p></li>
<li><p>In this case <span class="math notranslate nohighlight">\(g(\cdot)\)</span> corresponds to a weight matrix <span class="math notranslate nohighlight">\(\mathbf{W}_o\)</span>.</p></li>
<li><p>However, any other regression model can be used to implement the readout, including an MLP.</p></li>
</ul>
<img alt="../../_images/Readout.png" src="../../_images/Readout.png" />
<ul>
<li><p>Note that fitting an MLP to the readout states is different from the window approach we saw before.</p></li>
<li><p>Window approach:</p>
<ul class="simple">
<li><p>The model predicts a future value from the fixed amount of temporal information contained in the window</p></li>
</ul>
<div class="math notranslate nohighlight">
\[x(t+\tau) = g([x(t-P), \dots, x(t-1), x(t)])\]</div>
</li>
<li><p>Reservoir approach:</p>
<ul class="simple">
<li><p>The model predicts a future value from a single Reservoir state</p></li>
</ul>
<div class="math notranslate nohighlight">
\[x(t+\tau) = g(\mathbf{h}(t))\]</div>
</li>
</ul>
</section>
<section id="why-the-reservoir-approach-works">
<h3>Why the Reservoir approach works<a class="headerlink" href="#why-the-reservoir-approach-works" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The Reservoir extracts a rich pool dynamical features from the time series.</p></li>
<li><p>These are embedded into the high-dimensional Reservoir state <span class="math notranslate nohighlight">\(\mathbf{h}(t)\)</span>.</p></li>
<li><p>Contrary to a fixed window, <span class="math notranslate nohighlight">\(\mathbf{h}(t)\)</span> maintains a memory of all the previous inputs, back to the origin of the series <span class="math notranslate nohighlight">\(x(0)\)</span>.</p></li>
<li><p>Some of the features are relevant for the task at hand, while others are not.</p></li>
<li><p>The task of the readout is to select those features relevant for the task.</p></li>
</ul>
<ul class="simple">
<li><p>Say, we want make a forecast <span class="math notranslate nohighlight">\(\tau_1\)</span> steps ahead.</p></li>
<li><p>The readout will select a certain combination of dynamical features from the Reservoir.</p></li>
</ul>
<img alt="../../_images/Reservoir_pred1.png" src="../../_images/Reservoir_pred1.png" />
<ul class="simple">
<li><p>To predict at a different horizon <span class="math notranslate nohighlight">\(\tau_2\)</span> the readout will select a different group of features.</p></li>
<li><p>Note that in both cases the Readout produces always the same pool of features!</p></li>
</ul>
<img alt="../../_images/Reservoir_pred2.png" src="../../_images/Reservoir_pred2.png" />
<ul class="simple">
<li><p>The Readout is untrained and its states are generated without <em>supervision</em>, i.e., without an external guidance.</p></li>
<li><p>Since it does not know what task it will have to solve, the Readout is configured to produce a pool of dynamic features that is most rich and varied as possible.</p></li>
<li><p>In other words, the Readout trades the lack of training with a redudancy of generated features.</p></li>
</ul>
</section>
<section id="reservoir-configuration">
<h3>Reservoir configuration<a class="headerlink" href="#reservoir-configuration" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>There are several hyperparameters that can be configured in the Reservoir.</p></li>
<li><p>We review the main ones in the following.</p></li>
</ul>
<section id="spectral-radius">
<h4>Spectral radius<a class="headerlink" href="#spectral-radius" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Cleary, the contribution of more recent inputs must have a stronger influence on the current state.</p></li>
<li><p>This means that the Reservoir should gradually forget its past states.</p></li>
<li><p>This property, called <em>echo state property</em>, gives the name to the Echo State Network.</p></li>
<li><p>It ensures to not model noise, to forget sporadic shocks, and the initial state <span class="math notranslate nohighlight">\(\mathbf{h}(0)\)</span> that is uninformative.</p></li>
<li><p>In control theory, this translate in having a dynamic that is <em>contractive</em>.</p></li>
<li><p>A dynamic is contractive if two initially different states eventually converge.</p></li>
</ul>
<ul class="simple">
<li><p>On the other hand, we want the Reservoir to produce a rich pool of features.</p></li>
<li><p>If the dynamics of the Reservoir is too <em>conctractive</em> this does not happen.</p></li>
<li><p>We have to find a sweet spot by tuning a parameter <span class="math notranslate nohighlight">\(\rho\)</span> called <em>spectral radius</em>.</p></li>
</ul>
<img alt="../../_images/dynamics.png" src="../../_images/dynamics.png" />
<ul class="simple">
<li><p>Recall the state update equation</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\mathbf{h}(t) = \sigma \left(\mathbf{W}_i x(t)+\mathbf{W}_h \mathbf{h}(t-1)\right)\]</div>
<ul class="simple">
<li><p>The spectral radius is the largest eigenvalue of the state transtion matrix <span class="math notranslate nohighlight">\(W_h\)</span>.</p></li>
<li><p>We can <em>set</em> the spectral radius by computing the largest eigenvalue <span class="math notranslate nohighlight">\(\lambda_\text{max}\)</span> of <span class="math notranslate nohighlight">\(W_h\)</span> and then letting <span class="math notranslate nohighlight">\(W_h = \rho \frac{W_h}{\lambda_\text{max}}\)</span>.</p></li>
</ul>
<ul class="simple">
<li><p>A rule of thumb is to set <span class="math notranslate nohighlight">\(\rho\)</span> just below 1.</p></li>
<li><p>However, to achieve good performance it is often necessary to fine-tune <span class="math notranslate nohighlight">\(\rho\)</span> to values that can be lower or even higher than 1.</p></li>
</ul>
<ul class="simple">
<li><p>Another way of determining a good value of <span class="math notranslate nohighlight">\(\rho\)</span> is to look at the <em>transient</em> phase of the Reservoir.</p></li>
<li><p>This is how much time it takes to forget the initialization.</p></li>
<li><p>Assume two different inizializations of the Reservoir state: <span class="math notranslate nohighlight">\(\mathbf{h}_1(0)\)</span> and <span class="math notranslate nohighlight">\(\mathbf{h}_2(0)\)</span>.</p></li>
<li><p>If the Reservoir dynamics is contractive, the effect of the different initalizations will enventually fade.</p></li>
<li><p>If it is chaotic, it will persist.</p></li>
</ul>
<ul class="simple">
<li><p>Let’s check this with a practical example.</p></li>
<li><p>We consider two intializations, <span class="math notranslate nohighlight">\(\mathbf{h}_1(0) = [0,0,\dots,0]\)</span> and <span class="math notranslate nohighlight">\(\mathbf{h}_2(0) = [1,1,\dots, 1]\)</span>.</p></li>
<li><p>For this example, we set the input <span class="math notranslate nohighlight">\(x\)</span> to be always zero to not let it affect the evolution of the Reservoir state.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initial states</span>
<span class="n">initial_state_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> 
<span class="n">initial_state_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1"># Zero input, it does not contribute to the state</span>
<span class="n">rhos</span> <span class="o">=</span> <span class="p">[</span><span class="mf">.3</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">]</span>    <span class="c1"># We will use three different spectral radii</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_states_evolution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rhos</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">h1</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">rho</span> <span class="ow">in</span> <span class="n">rhos</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Reservoir</span><span class="p">(</span><span class="n">spectral_radius</span><span class="o">=</span><span class="n">rho</span><span class="p">)</span> <span class="c1"># initialize the reservoir with a given spectral radius</span>
        <span class="n">states_0</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get_states</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bidir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initial_state</span><span class="o">=</span><span class="n">h0</span><span class="p">)</span> <span class="c1"># states using initial state 0</span>
        <span class="n">states_1</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get_states</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bidir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">initial_state</span><span class="o">=</span><span class="n">h1</span><span class="p">)</span> <span class="c1"># states using initial state 1</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">states_0</span> <span class="o">-</span> <span class="n">states_1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;rho=</span><span class="si">{</span><span class="n">rho</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># L2 norm of the difference</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$t$&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$\|\mathbf</span><span class="si">{h}</span><span class="s1">_1(t) - \mathbf</span><span class="si">{h}</span><span class="s1">_2(t)\|_2$&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Transient phase of the Reservoir&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_states_evolution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rhos</span><span class="p">,</span> <span class="n">initial_state_0</span><span class="p">,</span> <span class="n">initial_state_1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/470f215636005997bc798d5a50c8f9e2f9ef27bc1c30c43570715a0f01565398.png" src="../../_images/470f215636005997bc798d5a50c8f9e2f9ef27bc1c30c43570715a0f01565398.png" />
</div>
</div>
</section>
<section id="input-scaling">
<h4>Input scaling<a class="headerlink" href="#input-scaling" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Another critical value is the input scaling <span class="math notranslate nohighlight">\(\omega_\text{in}\)</span>.</p></li>
<li><p>Is a value that multiplies the input weights <span class="math notranslate nohighlight">\(W_i\)</span> changing their magnitude.</p></li>
<li><p>This is key to control the amount of nonlinearity in the model.</p></li>
</ul>
<ul class="simple">
<li><p>Reservoir units are usually equipped with a <span class="math notranslate nohighlight">\(\texttt{tanh}\)</span> activation.</p></li>
<li><p>A small value <span class="math notranslate nohighlight">\(\omega_\text{in}\)</span> maps the Reservoir inputs towards the centre of the <span class="math notranslate nohighlight">\(\texttt{tanh}\)</span> where is more linear.</p></li>
<li><p>Therefore, a small <span class="math notranslate nohighlight">\(\omega_\text{in}\)</span> reduces the amount of nonlinearity in the Reservoir.</p></li>
<li><p>On the other hand, a large <span class="math notranslate nohighlight">\(\omega_\text{in}\)</span> translates into a more nonlinear beahvior as the <span class="math notranslate nohighlight">\(\texttt{tanh}\)</span> is closer to saturation.</p></li>
</ul>
<img alt="../../_images/tanh.png" src="../../_images/tanh.png" />
<ul class="simple">
<li><p>Like for the spectral radius, <span class="math notranslate nohighlight">\(\omega_\text{in}\)</span> should be tuned carefully.</p></li>
<li><p>A good starting value is usually around 0.1.</p></li>
</ul>
<ul class="simple">
<li><p>Another hypeparameter is the number of Reservoir units <span class="math notranslate nohighlight">\(N_h\)</span>.</p></li>
<li><p>A larger value can give better performance at the cost of higher computation time.</p></li>
<li><p>A good starting point is usually <span class="math notranslate nohighlight">\(N_h=300\)</span>, to be increased until there is no more gain in performance.</p></li>
</ul>
<ul class="simple">
<li><p>There are also other hyperparameters in the ESN, such as the sparsity of the Readout and an optional noise to inject in the state update equation.</p></li>
<li><p>These are usually less critical than <span class="math notranslate nohighlight">\(\rho\)</span> and <span class="math notranslate nohighlight">\(\omega_\text{in}\)</span> and can be left to their default value in most cases.</p></li>
<li><p>Tuning hyperparameters in randomized architectures such as the ESN is much more important than in trainable neural networks, since there is no training that can compensate for poorly initialized models.</p></li>
</ul>
</section>
</section>
</section>
<hr class="docutils" />
<section id="python-example-electricity-load-forecasting-with-esn">
<h2>Python example: electricity load forecasting with ESN<a class="headerlink" href="#python-example-electricity-load-forecasting-with-esn" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>In the following, we will use the <a class="reference external" href="https://github.com/FilippoMB/Time-series-classification-and-clustering-with-Reservoir-Computing">Python library</a> <code class="docutils literal notranslate"><span class="pre">reservoir-computing</span></code>.</p></li>
<li><p>The library allows us to perform time series classification, clustering, and forecasting with Reservoir Computing.</p></li>
<li><p>In this lecture, we will focus on <em>forecasting</em>.</p></li>
</ul>
<section id="load-the-data">
<h3>Load the data<a class="headerlink" href="#load-the-data" title="Link to this heading">#</a></h3>
<p>We reload the same time series of energy load that we used before.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts_full</span> <span class="o">=</span> <span class="n">PredLoader</span><span class="p">()</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;ElecRome&#39;</span><span class="p">)</span>

<span class="c1"># Resample the time series to hourly frequency</span>
<span class="n">ts_hourly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ts_full</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>

<span class="c1"># Use only the first 3000 time steps</span>
<span class="n">time_series</span> <span class="o">=</span> <span class="n">ts_hourly</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3000</span><span class="p">,</span> <span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loaded ElecRome dataset.
Data shape:
  X: (137376, 1)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>To train the ESN we need input and target data <code class="docutils literal notranslate"><span class="pre">Xtr</span></code> and <code class="docutils literal notranslate"><span class="pre">Ytr</span></code>.</p></li>
<li><p>We also need test data <code class="docutils literal notranslate"><span class="pre">Xte</span></code> and <code class="docutils literal notranslate"><span class="pre">Yte</span></code> to test the model and validation data <code class="docutils literal notranslate"><span class="pre">Xval</span></code> and <code class="docutils literal notranslate"><span class="pre">Yval</span></code> if we need to do hyperparameters tuning.</p></li>
<li><p>We will use the function <code class="docutils literal notranslate"><span class="pre">forecasting_datasets</span></code> that given a time series <code class="docutils literal notranslate"><span class="pre">X</span></code> does the following computations.</p></li>
</ul>
<ol class="arabic simple">
<li><p>Splits the dataset in consecutive chunks: <code class="docutils literal notranslate"><span class="pre">train</span></code>, <code class="docutils literal notranslate"><span class="pre">val</span></code> and <code class="docutils literal notranslate"><span class="pre">test</span></code>.</p>
<ul class="simple">
<li><p>The size of the chunks is given by the values <code class="docutils literal notranslate"><span class="pre">val_percent</span></code> and <code class="docutils literal notranslate"><span class="pre">test_percent</span></code>.</p></li>
<li><p>If we do not need validation data, set <code class="docutils literal notranslate"><span class="pre">val_percent=0</span></code> (default) and the validation data will not be created.</p></li>
</ul>
</li>
</ol>
<ol class="arabic simple" start="2">
<li><p>Create input data <code class="docutils literal notranslate"><span class="pre">X</span></code> and target data <code class="docutils literal notranslate"><span class="pre">Y</span></code> by shifting the data <code class="docutils literal notranslate"><span class="pre">horizon</span></code> time steps, where <code class="docutils literal notranslate"><span class="pre">horizon</span></code> is how far we want to predict.</p></li>
</ol>
<ul class="simple">
<li><p>For example:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Xtr</span> <span class="pre">=</span> <span class="pre">train[:-horizon,:]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Ytr</span> <span class="pre">=</span> <span class="pre">train[horizon:,:]</span></code></p></li>
</ul>
</li>
</ul>
<ol class="arabic simple">
<li><p>Normalizes the data using a scaler from <code class="docutils literal notranslate"><span class="pre">sklearn.preprocessing</span></code>.</p>
<ul class="simple">
<li><p>If no scalers are passed, a <code class="docutils literal notranslate"><span class="pre">StandardScaler</span></code> is created.</p></li>
<li><p>The scaler is fit on <code class="docutils literal notranslate"><span class="pre">Xtr</span></code> and then used to transform <code class="docutils literal notranslate"><span class="pre">Ytr</span></code>, <code class="docutils literal notranslate"><span class="pre">Xval</span></code>, and <code class="docutils literal notranslate"><span class="pre">Xte</span></code>.</p></li>
<li><p>Note that <code class="docutils literal notranslate"><span class="pre">Yval</span></code> and <code class="docutils literal notranslate"><span class="pre">Yte</span></code> are <strong>not</strong> transformed.</p></li>
</ul>
</li>
</ol>
<ul class="simple">
<li><p>The code below exemplifies the use of the function.</p></li>
<li><p>Note that we loose some data due to splitting and shifting.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">36</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">Xtr</span><span class="p">,</span> <span class="n">Ytr</span><span class="p">,</span> <span class="n">Xte</span><span class="p">,</span> <span class="n">Yte</span><span class="p">,</span> <span class="n">Xval</span><span class="p">,</span> <span class="n">Yval</span><span class="p">,</span> <span class="n">scaler</span> <span class="o">=</span> <span class="n">make_forecasting_dataset</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                                                  <span class="n">test_percent</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
                                                                  <span class="n">val_percent</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Xtr: &quot;</span><span class="p">,</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">Xtr</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ytr: &quot;</span><span class="p">,</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">Ytr</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Xval: &quot;</span><span class="p">,</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">Xval</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Yval: &quot;</span><span class="p">,</span> <span class="n">Yval</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Xte: &quot;</span><span class="p">,</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">Xte</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Yte: &quot;</span><span class="p">,</span> <span class="n">Yte</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Xtr:  [ 0.  1.  2.  3.  4.  5.  6.  7.  8.  9. 10. 11.]
Ytr:  [[ 5.  6.  7.  8.  9. 10. 11. 12. 13. 14. 15. 16.]]
Xval:  [17. 18. 19. 20. 21. 22.]
Yval:  [[22 23 24 25 26 27]]
Xte:  [28. 29. 30.]
Yte:  [[33 34 35]]
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Back to our real data: we want to make forecast 24h ahead.</p></li>
<li><p>In a real use case, we must optimize the hyperparameters on a valiation set.</p></li>
<li><p>However, since this is just a demonstration, we will use the default hyperparameters.</p></li>
<li><p>Therefore, we leave the default <code class="docutils literal notranslate"><span class="pre">val_percent=0</span></code> and the validation set is not created.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate training and test datasets</span>
<span class="n">Xtr</span><span class="p">,</span> <span class="n">Ytr</span><span class="p">,</span> <span class="n">Xte</span><span class="p">,</span> <span class="n">Yte</span><span class="p">,</span> <span class="n">scaler</span> <span class="o">=</span> <span class="n">make_forecasting_dataset</span><span class="p">(</span><span class="n">time_series</span><span class="p">,</span>
                                                      <span class="n">horizon</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="c1"># forecast horizon of 24h ahead</span>
                                                      <span class="n">test_percent</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Xtr shape: </span><span class="si">{</span><span class="n">Xtr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="se">\n</span><span class="s2">Ytr shape: </span><span class="si">{</span><span class="n">Ytr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="se">\n</span><span class="s2">Xte shape: </span><span class="si">{</span><span class="n">Xte</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="se">\n</span><span class="s2">Yte shape: </span><span class="si">{</span><span class="n">Yte</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Xtr shape: (2676, 2)
Ytr shape: (2676, 1)
Xte shape: (276, 2)
Yte shape: (276, 1)
</pre></div>
</div>
</div>
</div>
</section>
<section id="define-the-reservoir-and-compute-the-states">
<h3>Define the Reservoir and compute the states<a class="headerlink" href="#define-the-reservoir-and-compute-the-states" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>First, we specify the Reservoir hyperparameters and we initialize it.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res</span><span class="o">=</span> <span class="n">Reservoir</span><span class="p">(</span><span class="n">n_internal_units</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
               <span class="n">spectral_radius</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
               <span class="n">input_scaling</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
               <span class="n">connectivity</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Then, we compute the sequence of the Reservoir states <code class="docutils literal notranslate"><span class="pre">states_tr</span></code> and <code class="docutils literal notranslate"><span class="pre">states_te</span></code> associated with the training and test data, respecitvely.</p></li>
<li><p>Since the initial states of the Reservoir mostly depend on the initialization, e.g.,  <span class="math notranslate nohighlight">\(\mathbf{h}(0) = [0,0,\dots,0]\)</span>, we want to get rid of the initial transient phase.</p></li>
<li><p>This can be done by setting <code class="docutils literal notranslate"><span class="pre">n_drop</span></code> that specifies how many of the initial states we drop.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_drop</span><span class="o">=</span><span class="mi">10</span>
<span class="n">states_tr</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get_states</span><span class="p">(</span><span class="n">Xtr</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:],</span> <span class="n">n_drop</span><span class="o">=</span><span class="n">n_drop</span><span class="p">,</span> <span class="n">bidir</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">states_te</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get_states</span><span class="p">(</span><span class="n">Xte</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:],</span> <span class="n">n_drop</span><span class="o">=</span><span class="n">n_drop</span><span class="p">,</span> <span class="n">bidir</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;states_tr shape: </span><span class="si">{</span><span class="n">states_tr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="se">\n</span><span class="s2">states_te shape: </span><span class="si">{</span><span class="n">states_te</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>states_tr shape: (1, 2666, 900)
states_te shape: (1, 266, 900)
</pre></div>
</div>
</div>
</div>
</section>
<section id="fit-a-linear-readout">
<h3>Fit a linear readout<a class="headerlink" href="#fit-a-linear-readout" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>We are now ready to train the readout to predict the desired output given the sequence of Reservoir states.</p></li>
<li><p>We start by using a linear readout implemented by a Ridge regressor.</p></li>
<li><p>After the readout is trained, we use it to compute the predictions <span class="math notranslate nohighlight">\(\hat{Y}_\text{te}\)</span> of the test data.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the ridge regression model</span>
<span class="n">ridge</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span> 
<span class="n">time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">ridge</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">states_tr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ytr</span><span class="p">[</span><span class="n">n_drop</span><span class="p">:,:])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time_start</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="c1"># Compute the predictions</span>
<span class="n">time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">Yhat</span> <span class="o">=</span> <span class="n">ridge</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">states_te</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time_start</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training time: 0.0270s
Test time: 0.0004s
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Finally, we plot the results and compute the MSE.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Yte</span><span class="p">[</span><span class="n">n_drop</span><span class="p">:,:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">Yhat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predicted&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;True vs predicted electricity load&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2d90136f0f4f02189ddd547d40169319c9e1ef5922320a5f7ad86d7dc16fa458.png" src="../../_images/2d90136f0f4f02189ddd547d40169319c9e1ef5922320a5f7ad86d7dc16fa458.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">Yhat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">Yte</span><span class="p">[</span><span class="n">n_drop</span><span class="p">:,:])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean Squared Error: </span><span class="si">{</span><span class="n">mse</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mean Squared Error: 20.41
</pre></div>
</div>
</div>
</div>
</section>
<section id="reducing-the-dimensionality-of-the-reservoir-states">
<h3>Reducing the dimensionality of the Reservoir states<a class="headerlink" href="#reducing-the-dimensionality-of-the-reservoir-states" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>As discussed earlier, the Reservoir states contain a rich, yet often redundant, pool of dynamics.</p></li>
<li><p>The readout job is to select only the dynamics that are useful for the task at hand.</p></li>
<li><p>However, training a readout on high-dimensional states is computational demanding, especially when using a sophisticated readout.</p></li>
<li><p>In addition, working with high dimensional data can increase the risk of multicollinearity, which destabilizes certain models, and overfitting.</p></li>
</ul>
<ul class="simple">
<li><p>It can be desirable reducing to some extent the redundancy in the Reservoir states.</p></li>
<li><p>This can be done with an unsupervised dimensionality reduction procedure.</p></li>
<li><p>The most common and efficient dimensionality reduction procedure is PCA.</p></li>
</ul>
<section id="principal-component-analysis-pca">
<h4>Principal Component Analysis (PCA)<a class="headerlink" href="#principal-component-analysis-pca" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>PCA is a statistical procedure that utilizes an orthogonal transformation to convert a set of observations of possibly correlated variables into a set of values of linearly uncorrelated variables called <em>principal components</em>.</p></li>
<li><p>The number of principal components is less than or equal to the number of original variables.</p></li>
<li><p>By using a few components, PCA reduces the dimensionality of large data sets, by projecting the data onto a lower-dimensional space with minimal loss of information.</p></li>
</ul>
<ul class="simple">
<li><p>Our data is a sequence of length <span class="math notranslate nohighlight">\(T\)</span> of Reservoir states, each one of size <span class="math notranslate nohighlight">\(N_h\)</span>.</p></li>
<li><p>They can be arranged in a matrix <span class="math notranslate nohighlight">\(\mathbf{H} \in \mathbb{R}^{T \times N_h}\)</span>.</p></li>
<li><p>To illustrate the procedure, let’s first consider a toy example with only <span class="math notranslate nohighlight">\(N_h = 3\)</span> features.</p></li>
<li><p>In addition, we will create some structure in the data, by dividing the samples in 4 groups/clusters.</p></li>
<li><p>This will help us to see how PCA preserves the structure in the data.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate 4 clusters of points in 3 dimensions</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">300</span> <span class="c1"># number of samples</span>
<span class="n">N_h</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># number of features</span>
<span class="n">H</span><span class="p">,</span> <span class="n">clust_id</span> <span class="o">=</span> <span class="n">make_blobs</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">n_features</span><span class="o">=</span><span class="n">N_h</span><span class="p">,</span> 
                         <span class="n">centers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cluster_std</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_data</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">clust_id</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">H</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">H</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">H</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span> 
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">clust_id</span><span class="p">,</span> <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;Viridis&#39;</span><span class="p">)),</span>
        <span class="p">])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;X Axis&#39;</span><span class="p">,</span>
                                     <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Y Axis&#39;</span><span class="p">,</span>
                                     <span class="n">zaxis_title</span><span class="o">=</span><span class="s1">&#39;Z Axis&#39;</span><span class="p">,</span>
                                     <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">])),</span>
                          <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                          <span class="n">width</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span> 
                        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter3D</span><span class="p">(</span><span class="n">xs</span><span class="o">=</span><span class="n">H</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ys</span><span class="o">=</span><span class="n">H</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">zs</span><span class="o">=</span><span class="n">H</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">clust_id</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zticks</span><span class="p">(())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set interactive = True to get an interactive plot that can be rotated</span>
<span class="n">plot_data</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">clust_id</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/c6b4921d0c50be5d49cebb6a9d8c2d60eb026bc5317e0ee2c48eec124e6509cb.png" src="../../_images/c6b4921d0c50be5d49cebb6a9d8c2d60eb026bc5317e0ee2c48eec124e6509cb.png" />
</div>
</div>
<p>Reducing the data dimensionality with PCA invole the following steps:</p>
<ol class="arabic simple">
<li><p><strong>Standardization</strong></p></li>
</ol>
<ul class="simple">
<li><p>Scale the data so that each feature has a mean of 0 and a standard deviation of 1.</p></li>
<li><p>This is important because PCA is affected by scale.</p></li>
</ul>
<ol class="arabic simple" start="2">
<li><p><strong>Covariance matrix computation</strong>:</p></li>
</ol>
<ul class="simple">
<li><p>Calculate the empirical covariance matrix <span class="math notranslate nohighlight">\(\mathbf{H}^T\mathbf{H}\)</span>.</p></li>
<li><p>The matrix shows how changes in one variable are associated with changes in another variable.</p></li>
</ul>
<ol class="arabic simple" start="3">
<li><p><strong>Eigenvalues and eigenvectors computation</strong></p></li>
</ol>
<ul class="simple">
<li><p>The eigenvectors of the covariance matrix represent the directions of maximum variance.</p></li>
<li><p>In the context of PCA, the eigenvectors are the principal components.</p></li>
<li><p>The eigenvalues indicate the variance explained by each principal component.</p></li>
</ul>
<ol class="arabic simple" start="4">
<li><p><strong>Sorting eigenvectors</strong>:</p></li>
</ol>
<ul class="simple">
<li><p>The eigenvectors are sorted by decreasing eigenvalues.</p></li>
<li><p>The top-<span class="math notranslate nohighlight">\(k\)</span> eigenvectors are selected, where <span class="math notranslate nohighlight">\(k\)</span> is the number of dimensions we want to keep.</p></li>
<li><p>In our case, we keep <span class="math notranslate nohighlight">\(k=2\)</span> dimensions.</p></li>
</ul>
<ol class="arabic simple" start="5">
<li><p><strong>Projection onto the new feature space</strong>:</p></li>
</ol>
<ul class="simple">
<li><p>The original data are projected onto the selected principal components.</p></li>
<li><p>In our case, the 3-dimensional data are projected onto the plane spanned by the first two principale components.</p></li>
<li><p>The projected data are the reduced-dimensional data.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply PCA to reduce to 2 components</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">H_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
<span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">components_</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_pca_plane</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">clust_id</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">another_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">another_length</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_z</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">point_in_plane</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">+</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">v2</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">point_in_plane</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">z</span>
    <span class="n">Z_grid</span> <span class="o">=</span> <span class="n">compute_z</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">Z_grid</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">xx</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yy</span><span class="p">,</span> <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter3d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">H</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">H</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">H</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span> 
                         <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">clust_id</span><span class="p">,</span> <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;Viridis&#39;</span><span class="p">))])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">scene</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;X Axis&#39;</span><span class="p">,</span>
                                     <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Y Axis&#39;</span><span class="p">,</span>
                                     <span class="n">zaxis_title</span><span class="o">=</span><span class="s1">&#39;Z Axis&#39;</span><span class="p">,</span>
                                     <span class="n">zaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">])),</span>
                          <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                          <span class="n">width</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> 
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>

        <span class="n">surf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">Z_grid</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter3D</span><span class="p">(</span><span class="n">xs</span><span class="o">=</span><span class="n">H</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ys</span><span class="o">=</span><span class="n">H</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">zs</span><span class="o">=</span><span class="n">H</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">clust_id</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zticks</span><span class="p">(())</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the hyperplane spanned by the first two principal components</span>
<span class="n">plot_pca_plane</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">clust_id</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/bca69677470efc626e807df40e7e1e9dd9bc5118718c1508d25bc9aa78a6675e.png" src="../../_images/bca69677470efc626e807df40e7e1e9dd9bc5118718c1508d25bc9aa78a6675e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the 2D projection</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">H_pca</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">H_pca</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">clust_id</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([],</span> <span class="p">[]),</span> <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([],</span> <span class="p">[])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/d38d6984d942945f6ceac5f99dccd43e44145d26b7b59bd6d9382cfae90ec58a.png" src="../../_images/d38d6984d942945f6ceac5f99dccd43e44145d26b7b59bd6d9382cfae90ec58a.png" />
</div>
</div>
<ul class="simple">
<li><p>We can further reduce the number of dimensions.</p></li>
<li><p>In this case, we can go down to 1 dimension.</p></li>
<li><p>It boils down to projecting the data into the direction of maximum variation.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">H_pca_1d</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>

<span class="c1"># Plot the 1D projection</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">H_pca_1d</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">H_pca_1d</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="n">clust_id</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([],</span> <span class="p">[]),</span> <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([],</span> <span class="p">[])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/08eb9cfb3b51938954456bc13552f1209bd4441143a09afbd09527ef98775755.png" src="../../_images/08eb9cfb3b51938954456bc13552f1209bd4441143a09afbd09527ef98775755.png" />
</div>
</div>
<ul class="simple">
<li><p>💡 Check <a class="reference external" href="https://setosa.io/ev/principal-component-analysis/">this blog</a> for an excellent visual explanation and interactive examples about PCA.</p></li>
</ul>
</section>
<section id="id1">
<h4>Reducing the dimensionality of the Reservoir states<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Let’s go back to our Reservoir states, which in our case are very high-dimensional vectors.</p></li>
<li><p>In particular, since <code class="docutils literal notranslate"><span class="pre">n_internal_units=900</span></code>, we end up with a sequence of length <code class="docutils literal notranslate"><span class="pre">T</span></code> of vectors with size <code class="docutils literal notranslate"><span class="pre">900</span></code>.</p></li>
<li><p>We will use PCA to reduce the dimension of the reservoir states to <code class="docutils literal notranslate"><span class="pre">75</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">75</span><span class="p">)</span>
<span class="n">states_tr_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">states_tr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">states_te_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">states_te</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;states_tr shape: </span><span class="si">{</span><span class="n">states_tr_pca</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="se">\n</span><span class="s2">states_te shape: </span><span class="si">{</span><span class="n">states_te_pca</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>states_tr shape: (2666, 75)
states_te shape: (266, 75)
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Below, we fit the readout on the new data and compute the results on the test set.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit the ridge regression model</span>
<span class="n">ridge</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span> 
<span class="n">time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">ridge</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">states_tr_pca</span><span class="p">,</span> <span class="n">Ytr</span><span class="p">[</span><span class="n">n_drop</span><span class="p">:,:])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time_start</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="c1"># Compute the predictions</span>
<span class="n">time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">Yhat_pca</span> <span class="o">=</span> <span class="n">ridge</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">states_te_pca</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time_start</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="c1"># Compute the mean squared error</span>
<span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">Yhat_pca</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">Yte</span><span class="p">[</span><span class="n">n_drop</span><span class="p">:,:])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean Squared Error: </span><span class="si">{</span><span class="n">mse</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training time: 0.0025s
Test time: 0.0003s
Mean Squared Error: 21.96
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Even with a drastic reduction of the dimensionality, the performance remained more or less unchanged.</p></li>
<li><p>On the other hand, we reduce the computation time both in training and in test.</p></li>
<li><p>This reduction in computing time is particularly significant when using more sophisticated readouts, like the one we will try next.</p></li>
</ul>
</section>
</section>
<section id="fit-a-gbrt-readout">
<h3>Fit a GBRT readout<a class="headerlink" href="#fit-a-gbrt-readout" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Mapping the Reservoir states to the desired output is a standard regression problem, which can be solved by one of the many standard regression models in <a class="reference external" href="https://scikit-learn.org/stable/supervised_learning.html">scikit-learn</a>.</p></li>
<li><p>For example, we can use a Gradient Boost Regression Tree (GBRT), which gives us predictions for different quantiles.</p></li>
<li><p>In this way, we can compute confidence intervals in our predictions.</p></li>
<li><p>This is a very simple way to implement probabilistic forecasting.</p></li>
</ul>
<ul class="simple">
<li><p>In the following, we will fit a different model for the 0.5, 0.05 and 0.95 quantiles.</p></li>
<li><p>The 0.5 quantile will give us the most likely prediction for the future values.</p></li>
<li><p>The 0.05 and 0.95 quantiles together will us a 90% confidence interval for our prediction.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># Quantile 0.5</span>
<span class="n">max_iter</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">gbrt_median</span> <span class="o">=</span> <span class="n">HistGradientBoostingRegressor</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span> <span class="n">quantile</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">)</span>
<span class="n">gbrt_median</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">states_tr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ytr</span><span class="p">[</span><span class="n">n_drop</span><span class="p">:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">median_predictions</span> <span class="o">=</span> <span class="n">gbrt_median</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">states_te</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Quantile 0.05</span>
<span class="n">gbrt_percentile_5</span> <span class="o">=</span> <span class="n">HistGradientBoostingRegressor</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span> <span class="n">quantile</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">)</span>
<span class="n">gbrt_percentile_5</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">states_tr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ytr</span><span class="p">[</span><span class="n">n_drop</span><span class="p">:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">percentile_5_predictions</span> <span class="o">=</span> <span class="n">gbrt_percentile_5</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">states_te</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Quantile 0.95</span>
<span class="n">gbrt_percentile_95</span> <span class="o">=</span> <span class="n">HistGradientBoostingRegressor</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span> <span class="n">quantile</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">)</span>
<span class="n">gbrt_percentile_95</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">states_tr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Ytr</span><span class="p">[</span><span class="n">n_drop</span><span class="p">:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">percentile_95_predictions</span> <span class="o">=</span> <span class="n">gbrt_percentile_95</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">states_te</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training time: 3.26s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the results</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Yte</span><span class="p">[</span><span class="n">n_drop</span><span class="p">:,:],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">median_predictions</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Median prediction&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Yte</span><span class="p">[</span><span class="n">n_drop</span><span class="p">:,:])),</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">percentile_5_predictions</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">percentile_95_predictions</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;90% CI&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Predicted electricity load using Gradient Boosting Regression Trees&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0ee8118db0ab5b4177e52e2e8392788a6de8ae23fc0a10c8e109a4a5dbd6896d.png" src="../../_images/0ee8118db0ab5b4177e52e2e8392788a6de8ae23fc0a10c8e109a4a5dbd6896d.png" />
</div>
</div>
<ul class="simple">
<li><p>Finally, we repeat the training on the states reduced with PCA.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># Quantile 0.5</span>
<span class="n">max_iter</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">gbrt_median</span> <span class="o">=</span> <span class="n">HistGradientBoostingRegressor</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span> <span class="n">quantile</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">)</span>
<span class="n">gbrt_median</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">states_tr_pca</span><span class="p">,</span> <span class="n">Ytr</span><span class="p">[</span><span class="n">n_drop</span><span class="p">:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">median_predictions</span> <span class="o">=</span> <span class="n">gbrt_median</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">states_te_pca</span><span class="p">)</span>

<span class="c1"># Quantile 0.05</span>
<span class="n">gbrt_percentile_5</span> <span class="o">=</span> <span class="n">HistGradientBoostingRegressor</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span> <span class="n">quantile</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">)</span>
<span class="n">gbrt_percentile_5</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">states_tr_pca</span><span class="p">,</span> <span class="n">Ytr</span><span class="p">[</span><span class="n">n_drop</span><span class="p">:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">percentile_5_predictions</span> <span class="o">=</span> <span class="n">gbrt_percentile_5</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">states_te_pca</span><span class="p">)</span>

<span class="c1"># Quantile 0.95</span>
<span class="n">gbrt_percentile_95</span> <span class="o">=</span> <span class="n">HistGradientBoostingRegressor</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;quantile&quot;</span><span class="p">,</span> <span class="n">quantile</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">)</span>
<span class="n">gbrt_percentile_95</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">states_tr_pca</span><span class="p">,</span> <span class="n">Ytr</span><span class="p">[</span><span class="n">n_drop</span><span class="p">:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">percentile_95_predictions</span> <span class="o">=</span> <span class="n">gbrt_percentile_95</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">states_te_pca</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time_start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training time: 1.11s
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>The improvement in terms of computing time now is significant.</p></li>
</ul>
</section>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>In this lecture we saw:</p>
<ul class="simple">
<li><p>Neural Networks, the MLP, and how it can be used as a windowed model to perform time series forecasting.</p></li>
<li><p>The limitation of windowed approaches and how they can be solved by RNNs.</p></li>
<li><p>The ESN, a randomized RNN from the family of Reservoir Computing approaches that is fast and easy to train.</p></li>
<li><p>Examples of forecasting with MLP and ESN on real-world electricity data.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<section id="exercise-1">
<h3>Exercise 1<a class="headerlink" href="#exercise-1" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>In the MLP example, change the <code class="docutils literal notranslate"><span class="pre">window_size</span></code> (<span class="math notranslate nohighlight">\(P\)</span>) from 12 to 24.</p></li>
<li><p>Comment on the results and explain why the performance improve.</p></li>
</ul>
</section>
<section id="exercise-2">
<h3>Exercise 2<a class="headerlink" href="#exercise-2" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>In the MLP, change <code class="docutils literal notranslate"><span class="pre">forecast_horizon</span></code> from 24 to 36.</p></li>
<li><p>Do the same change also in the ESN.</p></li>
<li><p>With a forecast horizon of size 24 we used as a baseline the MSE between the time series and its shifted version by 24 lags, <code class="docutils literal notranslate"><span class="pre">mse</span> <span class="pre">=</span> <span class="pre">mean_squared_error(y_test[24:],</span> <span class="pre">y_test[:-24])</span></code>. Is this a good baseline also when the forecast horizon changes? What could be a better baseline?</p></li>
</ul>
</section>
<section id="exercise-3">
<h3>Exercise 3<a class="headerlink" href="#exercise-3" title="Link to this heading">#</a></h3>
<p>Contrarily from model-based approach such as ARIMA, the MLP and the ESN do not strctly require the data to be stationary. However, by removing trend and seasonality the MLP and the ESN can focus only on predicting the residuals.</p>
<ul class="simple">
<li><p>Remove trend and seasonality and train both MLP and ESN to train the residuals.</p></li>
<li><p>In testing, remember to put back the trend and seasonality when computing the predictions.</p></li>
<li><p>Compare the results with those obtained by training the MLP and the ESN on the original data.</p></li>
</ul>
</section>
<section id="exercise-4">
<h3>Exercise 4<a class="headerlink" href="#exercise-4" title="Link to this heading">#</a></h3>
<p>For this exercise, we will consider a new dataset consisting of hourly water temperatures from Gulf of Mexico near Key West, Florida.
The hourly temperatures are provided from October 3, 2016 to October 3, 2017
The dataset consists of a data frame with 6572 observations on the following 3 variables.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DateTime</span></code> Date and time of reading (format mm/dd/yyyy h:00).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">WaterTemp</span></code>: Water temperature (in degrees Fahrenheit).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">t</span></code>: Time index (1 to 673).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">temps</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">get_rdataset</span><span class="p">(</span><span class="s2">&quot;KeyWestWater&quot;</span><span class="p">,</span> <span class="s2">&quot;Stat2Data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raw data:</span><span class="se">\n</span><span class="s2">------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">temps</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temps</span><span class="p">[</span><span class="s2">&quot;WaterTemp&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Raw data:
------------------
          DateTime  WaterTemp  t
0  10/3/2016 0:00       86.2  1
1  10/3/2016 1:00       86.2  2
2  10/3/2016 2:00       86.2  3
3  10/3/2016 3:00       86.2  4
4  10/3/2016 4:00       86.0  5
</pre></div>
</div>
<img alt="../../_images/37d201e877dbf30e31c5d12fd159e8a3004fb38627751c94e7d5f934f71adafc.png" src="../../_images/37d201e877dbf30e31c5d12fd159e8a3004fb38627751c94e7d5f934f71adafc.png" />
</div>
</div>
<ul class="simple">
<li><p>Apply the MLP on the temperature data.</p></li>
<li><p>Perform a small grid search to try different values for the following hyperparameters:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">hidden_layer_sizes</span></code> (e.g., try more layers <code class="docutils literal notranslate"><span class="pre">[16,</span> <span class="pre">16,</span> <span class="pre">8]</span></code>, layers with more units <code class="docutils literal notranslate"><span class="pre">[32,</span> <span class="pre">16]</span></code>, etc…).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">learning_rate_init</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">activation</span></code> (try at least <code class="docutils literal notranslate"><span class="pre">tanh</span></code> and <code class="docutils literal notranslate"><span class="pre">relu</span></code>).</p></li>
</ul>
</li>
<li><p>Apply the ESN on the temperature data.</p></li>
<li><p>Perform a small grid search to try different values for the following hyperparameters:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">spectral_radius</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">input_scaling</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_internal_units</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">connectivity</span></code>.</p></li>
</ul>
</li>
</ul>
<p>Report the configuration of MLP and ESN that achieves the best performance on the test data.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/10"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../09/prophet.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Prophet</p>
      </div>
    </a>
    <a class="right-next"
       href="../11/nonlinear-ts.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Nonlinear time series analysis</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#windowed-approaches-for-prediction">Windowed approaches for prediction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#limitation-of-linear-models">Limitation of linear models</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-forecasting-electricity-demand">Example: forecasting electricity demand</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advantages-of-nonlinear-models">Advantages of Nonlinear Models</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#neural-networks">Neural networks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-layer-perceptron">Multi-Layer Perceptron</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-a-simple-mlp">Example: a simple MLP</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mlp-for-time-series-forecasting">MLP for time series forecasting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#python-example">Python example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#windowed-approaches-drawbacks">Windowed approaches drawbacks</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recurrent-neural-networks">Recurrent Neural Networks</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#challenges-and-shortcomings-in-rnns">Challenges and shortcomings in RNNs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reservoir-computing">Reservoir Computing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#readout">Readout</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-the-reservoir-approach-works">Why the Reservoir approach works</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reservoir-configuration">Reservoir configuration</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spectral-radius">Spectral radius</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#input-scaling">Input scaling</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#python-example-electricity-load-forecasting-with-esn">Python example: electricity load forecasting with ESN</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-data">Load the data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-the-reservoir-and-compute-the-states">Define the Reservoir and compute the states</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-a-linear-readout">Fit a linear readout</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reducing-the-dimensionality-of-the-reservoir-states">Reducing the dimensionality of the Reservoir states</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#principal-component-analysis-pca">Principal Component Analysis (PCA)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Reducing the dimensionality of the Reservoir states</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-a-gbrt-readout">Fit a GBRT readout</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-1">Exercise 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-2">Exercise 2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-3">Exercise 3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise-4">Exercise 4</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Filippo Maria Bianchi
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>