
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>ARMA, ARIMA, SARIMA &#8212; Time series analysis with Python</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/05/arma_arima_sarima';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Unit root test and Hurst exponent" href="../06/unit-root-hurst.html" />
    <link rel="prev" title="AR-MA" href="../04/ar-ma.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../00/intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Time series analysis with Python - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Time series analysis with Python - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../00/intro.html">
                    Time series analysis with Python
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01/introduction_to_time_series.html">Introduction to time series analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02/stationarity.html">Stationarity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03/smoothing.html">Smoothing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04/ar-ma.html">AR-MA</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">ARMA, ARIMA, SARIMA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../06/unit-root-hurst.html">Unit root test and Hurst exponent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../07/kalman-filter.html">Kalman filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../08/signal-transforms-filters.html">Signal transforms and filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09/prophet.html">Prophet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../10/nn-reservoir-computing.html">Neural networks and Reservoir Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11/nonlinear-ts.html">Nonlinear time series analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../12/classification-clustering.html">Time series classification and clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00/resources.html">Resources</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/FilippoMB/python-time-series-handbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/FilippoMB/python-time-series-handbook/issues/new?title=Issue%20on%20page%20%2Fnotebooks/05/arma_arima_sarima.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/05/arma_arima_sarima.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>ARMA, ARIMA, SARIMA</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#arma">ARMA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-series-modeling-process">Time Series Modeling Process</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data">Load data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#arma-model-stages">ARMA Model Stages</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-identification">Model Identification</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#determine-stationarity">Determine Stationarity</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#determine-seasonality">Determine Seasonality</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-the-main-seasonality">Remove the main seasonality</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#identifying-p-and-q">Identifying <span class="math notranslate nohighlight">\(p\)</span> and <span class="math notranslate nohighlight">\(q\)</span></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-estimation">Model estimation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#arma-model-validation">ARMA Model Validation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visual-inspection">Visual inspection</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#statistical-tests">Statistical tests</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#arma-model-predictions">ARMA Model Predictions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#arima-model">ARIMA Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sarima">SARIMA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#autoarima">AutoARIMA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#autoarima-or-not-autoarima">AutoARIMA or not AutoARIMA?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#grid-search">Grid Search</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction-performance">Prediction performance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-complexity">Model complexity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#restricting-the-search-with-exploratory-data-analysis-eda">Restricting the search with Exploratory Data Analysis (EDA)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-the-candidates-for-differentiation">Selecting the candidates for differentiation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#filter-out-non-stationary-candidates">Filter-out non-stationary candidates</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#select-candidates-for-orders-p-q-p-q">Select candidates for orders <span class="math notranslate nohighlight">\(p, q, P, Q\)</span></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-the-grid-of-hyperparameters-to-search">Define the grid of hyperparameters to search</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#train-the-models">Train the models</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#analyze-the-results">Analyze the results</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-performance-on-the-test-set">Compute performance on the test set</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise">Exercise</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="arma-arima-sarima">
<h1>ARMA, ARIMA, SARIMA<a class="headerlink" href="#arma-arima-sarima" title="Link to this heading">#</a></h1>
<br>
<div style="text-align: center">
    <img src="media/cover.png" style="width: 40%"\>
</div><section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>In the previous four lessons, we learned about stationarity, smoothing, trend, seasonality, and autocorrelation, and you built two different kinds of models:</p></li>
</ul>
<blockquote>
<div><p><strong>MA models</strong>: The current value of the series depends linearly on the series’ mean and a set of prior (observed) white noise error terms.</p>
</div></blockquote>
<blockquote>
<div><p><strong>AR models</strong>: The current value of the  series depends linearly on its own previous values and on a stochastic term (an imperfectly predictable term).</p>
</div></blockquote>
<ul class="simple">
<li><p>In this lesson we will review these concepts and combine the AR and MA models into three more complicated ones: ARMA, ARIMA, and SARIMA.</p></li>
</ul>
<p>In particular, we will cover:</p>
<ol class="arabic simple">
<li><p>Autoregressive Moving Average (ARMA) models.</p></li>
<li><p>Autoregressive Integrated Moving Average (ARIMA) models.</p></li>
<li><p>SARIMA models (ARIMA model for data with seasonality).</p></li>
<li><p>Selecting the best model.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Imports</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels</span> <span class="k">as</span> <span class="nn">ss</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy.fft</span> <span class="kn">import</span> <span class="n">fft</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.arima.model</span> <span class="kn">import</span> <span class="n">ARIMA</span>
<span class="kn">from</span> <span class="nn">statsmodels.graphics.tsaplots</span> <span class="kn">import</span> <span class="n">month_plot</span><span class="p">,</span> <span class="n">plot_acf</span><span class="p">,</span> <span class="n">plot_pacf</span>
<span class="kn">from</span> <span class="nn">statsmodels.graphics.gofplots</span> <span class="kn">import</span> <span class="n">qqplot</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">adfuller</span><span class="p">,</span> <span class="n">acf</span><span class="p">,</span> <span class="n">pacf</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.seasonal</span> <span class="kn">import</span> <span class="n">STL</span><span class="p">,</span> <span class="n">seasonal_decompose</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.statespace.sarimax</span> <span class="kn">import</span> <span class="n">SARIMAX</span>
<span class="kn">from</span> <span class="nn">statsmodels.tools.eval_measures</span> <span class="kn">import</span> <span class="n">mse</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.statespace.tools</span> <span class="kn">import</span> <span class="n">diff</span>
<span class="kn">import</span> <span class="nn">pmdarima</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="arma">
<h2>ARMA<a class="headerlink" href="#arma" title="Link to this heading">#</a></h2>
<p>The ARMA model (also known as the <em>Box-Jenkins</em> approach) combines two models:</p>
<ul class="simple">
<li><p>An autoregressive (AR) model of order <span class="math notranslate nohighlight">\(p\)</span>.</p></li>
<li><p>A moving average (MA) model of order <span class="math notranslate nohighlight">\(q\)</span>.</p></li>
</ul>
<ul class="simple">
<li><p>When we have autocorrelation between outcomes and their ancestors, there will be a pattern in the time series.</p></li>
<li><p>This relationship can be modeled using an ARMA model.</p></li>
<li><p>It allows us to predict the future with a confidence level proportional to the strength of the relationship and the proximity to known values (prediction weakens the further out we go).</p></li>
</ul>
<p><strong>📝 Note</strong></p>
<ul class="simple">
<li><p>ARMA models assume the time series is assumed to be stationary.</p></li>
<li><p>A good rule of thumb is to have at least 100 observations when fitting an ARMA model.</p></li>
</ul>
<section id="time-series-modeling-process">
<h3>Time Series Modeling Process<a class="headerlink" href="#time-series-modeling-process" title="Link to this heading">#</a></h3>
<p>Model selection is driven by the Trend and Seasonal components of our raw data.</p>
<p>The general approach for analysis looks like this:</p>
<ol class="arabic simple">
<li><p>Plot the data and determine Trends and Seasonality</p></li>
<li><p>Determine if we have additive or multiplicative data patterns</p></li>
<li><p>Select the appropriate algorithm based on the chart below</p></li>
</ol>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Algorithm</p></th>
<th class="head"><p>Trend</p></th>
<th class="head"><p>Seasonal</p></th>
<th class="head"><p>Correlations</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Simple Exponential Smoothing</p></td>
<td><p></p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p>Double Exponential Smoothing</p></td>
<td><p>X</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><p>Triple Exponential Smoothing</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p>ARIMA</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
</tr>
</tbody>
</table>
</section>
<section id="load-data">
<h3>Load data<a class="headerlink" href="#load-data" title="Link to this heading">#</a></h3>
<p>In the following, we’ll be looking at the monthly average temperatures between 1907-1972.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load data and convert to datetime</span>
<span class="n">monthly_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;https://zenodo.org/records/10951538/files/arima_temp.csv?download=1&#39;</span><span class="p">,</span> 
                           <span class="n">skipfooter</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                           <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                           <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                           <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">],</span>
                           <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
<span class="n">monthly_temp</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">monthly_temp</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This is how the data look like</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">monthly_temp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>temp</th>
    </tr>
    <tr>
      <th>month</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1907-01-01</th>
      <td>33.3</td>
    </tr>
    <tr>
      <th>1907-02-01</th>
      <td>46.0</td>
    </tr>
    <tr>
      <th>1907-03-01</th>
      <td>43.0</td>
    </tr>
    <tr>
      <th>1907-04-01</th>
      <td>55.0</td>
    </tr>
    <tr>
      <th>1907-05-01</th>
      <td>51.8</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>These are some statistics</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">monthly_temp</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>temp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>792.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>53.553662</td>
    </tr>
    <tr>
      <th>std</th>
      <td>15.815452</td>
    </tr>
    <tr>
      <th>min</th>
      <td>11.200000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>39.675000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>52.150000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>67.200000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>82.400000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Plot the data</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Monthly temperatures&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/73aad02d327215c2a163a31a46b94ec8155d132d03e00f319d464db7af1d74c2.png" src="../../_images/73aad02d327215c2a163a31a46b94ec8155d132d03e00f319d464db7af1d74c2.png" />
</div>
</div>
<p>Compute the annual mean and plot it on top of the actual data</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute annual mean </span>
<span class="n">annual_temp</span> <span class="o">=</span> <span class="n">monthly_temp</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;YE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">annual_temp</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;year&#39;</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">monthly_temp</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Monthly Temperatures&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">annual_temp</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Annual Mean&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2a52d860d638722e30ede930a55948a896dec11901c5d8a1999241e3c776588a.png" src="../../_images/2a52d860d638722e30ede930a55948a896dec11901c5d8a1999241e3c776588a.png" />
</div>
</div>
<ul class="simple">
<li><p>This gives us an indication that the mean is rather constant over the years.</p></li>
<li><p>We can extract further information abouth the underlying trend and seasonality by performing a seasonal decomposition.</p></li>
<li><p>We can use both the <code class="docutils literal notranslate"><span class="pre">seasonal_decompose</span></code> and the <code class="docutils literal notranslate"><span class="pre">STL</span></code> methods.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">decomposition</span> <span class="o">=</span> <span class="n">seasonal_decompose</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">],</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;additive&#39;</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">seasonal</span><span class="p">,</span> <span class="n">trend</span><span class="p">,</span> <span class="n">resid</span> <span class="o">=</span> <span class="n">decomposition</span><span class="o">.</span><span class="n">seasonal</span><span class="p">,</span> <span class="n">decomposition</span><span class="o">.</span><span class="n">trend</span><span class="p">,</span> <span class="n">decomposition</span><span class="o">.</span><span class="n">resid</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">seasonal</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Seasonal&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trend</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Trend&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/63b5f43c90d5d22a9726347e9a717d32d61efe62776046493573fd909755ff46.png" src="../../_images/63b5f43c90d5d22a9726347e9a717d32d61efe62776046493573fd909755ff46.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">decomposition</span> <span class="o">=</span> <span class="n">STL</span><span class="p">(</span><span class="n">endog</span><span class="o">=</span><span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">],</span> <span class="n">period</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">seasonal</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">seasonal</span><span class="p">,</span> <span class="n">trend</span><span class="p">,</span> <span class="n">resid</span> <span class="o">=</span> <span class="n">decomposition</span><span class="o">.</span><span class="n">seasonal</span><span class="p">,</span> <span class="n">decomposition</span><span class="o">.</span><span class="n">trend</span><span class="p">,</span> <span class="n">decomposition</span><span class="o">.</span><span class="n">resid</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">])</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">seasonal</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Seasonal&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trend</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Trend&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/3c6994aea313b3bbd0c5a64477d7f01719860acd7c6722536a3b09a01182c3ff.png" src="../../_images/3c6994aea313b3bbd0c5a64477d7f01719860acd7c6722536a3b09a01182c3ff.png" />
</div>
</div>
<ul class="simple">
<li><p>The seasonality is well defined.</p></li>
<li><p>It doesn’t seem to be a strong, time-varying trend in the data.</p>
<ul>
<li><p>We can assume the trend is constant.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="arma-model-stages">
<h2>ARMA Model Stages<a class="headerlink" href="#arma-model-stages" title="Link to this heading">#</a></h2>
<p>There are three stages in building an ARMA model:</p>
<ol class="arabic simple">
<li><p>Model identification</p></li>
<li><p>Model estimation</p></li>
<li><p>Model evaluation</p></li>
</ol>
<section id="model-identification">
<h3>Model Identification<a class="headerlink" href="#model-identification" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Model identification consists in finding the orders <span class="math notranslate nohighlight">\(p\)</span> and <span class="math notranslate nohighlight">\(q\)</span> AR and MA components.</p></li>
<li><p>Before performing model identification we need to:</p>
<ol class="arabic simple">
<li><p>Determine if the time series is stationary.</p></li>
<li><p>Determine if the time series has seasonal component.</p></li>
</ol>
</li>
</ul>
<section id="determine-stationarity">
<h4>Determine Stationarity<a class="headerlink" href="#determine-stationarity" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>We will use tools we already know (ADF test).</p></li>
<li><p>We can also look at the rolling mean and std.</p></li>
</ul>
<br>
<div style="text-align: center; font-size: 30px; font-weight: bold;">⚠ Attention! ⚠</div>
<br>
<ul class="simple">
<li><p>Before we continue, let’s consider the following result</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sinusoid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span>
<span class="n">_</span><span class="p">,</span> <span class="n">pvalue</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">sinusoid</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;p-value: </span><span class="si">{</span><span class="n">pvalue</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>p-value: 0.0
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Periodic signals, by their nature, have means and variances that repeat over the period of the cycle.</p></li>
<li><p>This implies that their statistical properties are functions of time within each period.</p></li>
<li><p>For instance, the mean of a periodic signal over one cycle may be constant.</p></li>
<li><p>However, when considering any point in time relative to the cycle, the instantaneous mean of the signal can vary.</p></li>
<li><p>Similarly, the variance can fluctuate within the cycle.</p></li>
</ul>
<ul class="simple">
<li><p>The ADF test specifically looks for a <em>unit root</em> (more on this later on).</p></li>
<li><p>A unit root indicates that shocks to the time series have a permanent effect, causing drifts in the level of the series.</p></li>
<li><p>A sinusoidal function, by contrast, is inherently <em>mean-reverting</em> within its cycles.</p></li>
<li><p>After a peak a sinusoid reverts to its mean and any “shock” in terms of phase shift or amplitude change does not alter its oscillatory nature.</p></li>
</ul>
<ul class="simple">
<li><p>It’s crucial to note that the ADF test’s conclusion of stationarity for a sinusoid does not imply that the sinusoid is stationary.</p></li>
<li><p>The test’s conclusion is about the absence of a unit root.</p></li>
<li><p>This does not imply that the mean and variance are constant within the periodic fluctuations.</p></li>
</ul>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">adftest</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">autolag</span><span class="o">=</span><span class="s1">&#39;AIC&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ADF Statistic: </span><span class="si">{</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;p-value: </span><span class="si">{</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Critical Values: </span><span class="si">{</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">zip</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span><span class="w"> </span><span class="n">out</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
        <span class="c1"># Compute rolling statistics</span>
        <span class="n">rolmean</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">rolstd</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="c1"># Plot rolling statistics:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolmean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Rolling Mean&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rolstd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Rolling Std&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Rolling Mean and Standard Deviation&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">();</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run ADF on monthly temperatures</span>
<span class="n">adftest</span><span class="p">(</span><span class="n">monthly_temp</span><span class="o">.</span><span class="n">temp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ADF Statistic: -6.48
p-value: 0.000
Critical Values: [&#39;1%: -3.44&#39;, &#39;5%: -2.87&#39;, &#39;10%: -2.57&#39;]
</pre></div>
</div>
<img alt="../../_images/7e0f0c608338a7598de83c3bfd9c266e7256adb35664298a004d85304c46064e.png" src="../../_images/7e0f0c608338a7598de83c3bfd9c266e7256adb35664298a004d85304c46064e.png" />
</div>
</div>
<ul class="simple">
<li><p>The p-value indicates that the time series is stationary…</p></li>
<li><p>… even if it clearly has a periodic component.</p></li>
<li><p>The rolling mean and rolling standard deviation seem globally constant along the time series…</p></li>
<li><p>… even if they change locally within the period.</p></li>
</ul>
</section>
<section id="determine-seasonality">
<h4>Determine Seasonality<a class="headerlink" href="#determine-seasonality" title="Link to this heading">#</a></h4>
<p>Determine whether seasonality is present by using the following tools:</p>
<ul class="simple">
<li><p>Autocorrelation plot.</p></li>
<li><p>Seasonal subseries plot (month plot).</p></li>
<li><p>Fourier Transform</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run ADF on annual means</span>
<span class="n">adftest</span><span class="p">(</span><span class="n">annual_temp</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># no point in plotting the rolling mean/std here</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ADF Statistic: -7.88
p-value: 0.000
Critical Values: [&#39;1%: -3.54&#39;, &#39;5%: -2.91&#39;, &#39;10%: -2.59&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate synthetic time series data</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2010-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;ME&#39;</span><span class="p">)</span>  <span class="c1"># Monthly data for 5 years</span>
<span class="n">seas</span> <span class="o">=</span> <span class="mi">12</span> <span class="c1"># change this and see how the plots change</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">seas</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># Seasonal data with noise</span>
<span class="n">series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">series</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Original time series&quot;</span><span class="p">)</span>

<span class="c1"># ACF Plot</span>
<span class="n">plot_acf</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="c1"># Convert series to a DataFrame and add a column for the month</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>

<span class="c1"># Seasonal Subseries Plot</span>
<span class="n">month_plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Seasonal Subseries Plot&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/096a94678cad8df1c302a8aec547a78c31be7a0022dea87e277f3e23c7dbc0a3.png" src="../../_images/096a94678cad8df1c302a8aec547a78c31be7a0022dea87e277f3e23c7dbc0a3.png" />
</div>
</div>
<ul class="simple">
<li><p>Let’s look at the real data now.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">month_plot</span><span class="p">(</span><span class="n">monthly_temp</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0812ba4d4ae0f04d8a0cb150d225943c61e3581d9e8b41bf57ec64e707feef71.png" src="../../_images/0812ba4d4ae0f04d8a0cb150d225943c61e3581d9e8b41bf57ec64e707feef71.png" />
</div>
</div>
<ul class="simple">
<li><p>Notice that a <code class="docutils literal notranslate"><span class="pre">violinplot</span></code> can give a very similar information to the <code class="docutils literal notranslate"><span class="pre">month_plot</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">monthly_temp</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">monthly_temp</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span> <span class="c1"># notice the indexing on the x by month</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/3386a497e68c94d5fc849338920a07f24f0452b31551321b3cc5a2b96e2546f5.png" src="../../_images/3386a497e68c94d5fc849338920a07f24f0452b31551321b3cc5a2b96e2546f5.png" />
</div>
</div>
<ul class="simple">
<li><p>Finally, to obtain the numerical value of the main periodicity we can use the Foruier Transfrom (more on this later).</p></li>
<li><p>Here, we’ll use the function we defined in the first lecture.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fft_analysis</span><span class="p">(</span><span class="n">signal</span><span class="p">):</span>
    <span class="c1"># Linear detrending</span>
    <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">signal</span><span class="p">)),</span> <span class="n">signal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">trend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">signal</span><span class="p">))</span> <span class="o">*</span> <span class="n">slope</span> <span class="o">+</span> <span class="n">intercept</span> 
    <span class="n">detrended</span> <span class="o">=</span> <span class="n">signal</span> <span class="o">-</span> <span class="n">trend</span> 

    <span class="n">fft_values</span> <span class="o">=</span> <span class="n">fft</span><span class="p">(</span><span class="n">detrended</span><span class="p">)</span>
    <span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fft_values</span><span class="p">))</span>

    <span class="c1"># Remove negative frequencies and sort</span>
    <span class="n">positive_frequencies</span> <span class="o">=</span> <span class="n">frequencies</span><span class="p">[</span><span class="n">frequencies</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">magnitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fft_values</span><span class="p">)[</span><span class="n">frequencies</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Identify dominant frequency</span>
    <span class="n">dominant_frequency</span> <span class="o">=</span> <span class="n">positive_frequencies</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">)]</span>

    <span class="c1"># Convert frequency to period (e.g., days, weeks, months, etc.)</span>
    <span class="n">dominant_period</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">dominant_frequency</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dominant Period: </span><span class="si">{</span><span class="n">dominant_period</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> time units&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dominant_period</span><span class="p">,</span> <span class="n">positive_frequencies</span><span class="p">,</span> <span class="n">magnitudes</span>

<span class="n">fft_analysis</span><span class="p">(</span><span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dominant Period: 12.00 time units
</pre></div>
</div>
</div>
</div>
</section>
<section id="remove-the-main-seasonality">
<h4>Remove the main seasonality<a class="headerlink" href="#remove-the-main-seasonality" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>In this case, it is clear that the main seasonality is <span class="math notranslate nohighlight">\(L=12\)</span>.</p></li>
<li><p>We can remove it with a seasonal differencing.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;Seasonally_Differenced&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Drop nan</span>
<span class="n">monthly_temp_clean</span> <span class="o">=</span> <span class="n">monthly_temp</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">monthly_temp_clean</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>temp</th>
      <th>Seasonally_Differenced</th>
    </tr>
    <tr>
      <th>month</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1908-01-01</th>
      <td>35.6</td>
      <td>2.3</td>
    </tr>
    <tr>
      <th>1908-02-01</th>
      <td>35.2</td>
      <td>-10.8</td>
    </tr>
    <tr>
      <th>1908-03-01</th>
      <td>48.1</td>
      <td>5.1</td>
    </tr>
    <tr>
      <th>1908-04-01</th>
      <td>50.0</td>
      <td>-5.0</td>
    </tr>
    <tr>
      <th>1908-05-01</th>
      <td>46.8</td>
      <td>-5.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1972-08-01</th>
      <td>75.6</td>
      <td>-4.9</td>
    </tr>
    <tr>
      <th>1972-09-01</th>
      <td>64.1</td>
      <td>-1.7</td>
    </tr>
    <tr>
      <th>1972-10-01</th>
      <td>51.7</td>
      <td>0.6</td>
    </tr>
    <tr>
      <th>1972-11-01</th>
      <td>40.3</td>
      <td>-1.5</td>
    </tr>
    <tr>
      <th>1972-12-01</th>
      <td>30.3</td>
      <td>-0.3</td>
    </tr>
  </tbody>
</table>
<p>780 rows × 2 columns</p>
</div></div></div>
</div>
<p><strong>⚙ Try it yourself</strong></p>
<ul class="simple">
<li><p>Try redoing the previous plots on the differenced data!</p></li>
</ul>
</section>
<section id="identifying-p-and-q">
<h4>Identifying <span class="math notranslate nohighlight">\(p\)</span> and <span class="math notranslate nohighlight">\(q\)</span><a class="headerlink" href="#identifying-p-and-q" title="Link to this heading">#</a></h4>
<p>As we learned in the previous lesson, we will identify the AR order <span class="math notranslate nohighlight">\(p\)</span> and the MA order <span class="math notranslate nohighlight">\(q\)</span> with:</p>
<ul class="simple">
<li><p>Autocorrelation plot.</p></li>
<li><p>Partial autocorrelation plot.</p></li>
</ul>
<p><strong>AR(<span class="math notranslate nohighlight">\(p\)</span>)</strong></p>
<ul class="simple">
<li><p>The order of the AR model is identified as follows:</p>
<ul>
<li><p>Plot 95% confidence interval on the PACF (done automatically by statsmodels).</p></li>
<li><p>Choose lag <span class="math notranslate nohighlight">\(p\)</span> such that partial autocorrelation becomes insignificant for <span class="math notranslate nohighlight">\(p+1\)</span> and beyond.</p></li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p>If a process depends on previous values of itself then it is an AR process.</p></li>
<li><p>If it depends on previous errors than it is an MA process.</p></li>
<li><p>An AR process propagates shocks infinitely.</p></li>
<li><p>AR processes will exhibit exponential decay in ACF and a cut-off in PACF.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plot_pacf</span><span class="p">(</span><span class="n">monthly_temp_clean</span><span class="p">[</span><span class="s1">&#39;Seasonally_Differenced&#39;</span><span class="p">],</span> <span class="n">lags</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">);</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f6f8aafbf06703a3638734613b4cb8344775ef6593922cc7a2b6ddac4321d89e.png" src="../../_images/f6f8aafbf06703a3638734613b4cb8344775ef6593922cc7a2b6ddac4321d89e.png" />
</div>
</div>
<ul class="simple">
<li><p>It looks like the PACF becomes zero at lag 2.</p></li>
<li><p>However there is a non-zero partial autocorrelation at lag 3.</p></li>
<li><p>The optimal value might be <span class="math notranslate nohighlight">\(p=1\)</span>, <span class="math notranslate nohighlight">\(p=2\)</span>, or <span class="math notranslate nohighlight">\(p=3\)</span>.</p></li>
<li><p>Note that there are high partial autocorrelations at higher lags, especially 12.</p>
<ul>
<li><p>This is an effect from seasonality and seasonal differencing.</p></li>
<li><p>It should not be accounted when chosing <span class="math notranslate nohighlight">\(p\)</span>.</p></li>
</ul>
</li>
</ul>
<p><strong>MA(<span class="math notranslate nohighlight">\(q\)</span>)</strong></p>
<ul class="simple">
<li><p>The order of the MA model is identified as follows</p>
<ul>
<li><p>Plot 95% confidence interval on the ACF (done automatically by statsmodels).</p></li>
<li><p>Choose lag <span class="math notranslate nohighlight">\(q\)</span> such that autocorrelation becomes statistically zero for <span class="math notranslate nohighlight">\(q+1\)</span> and beyond.</p></li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p>MA models do not propagate shocks infinitely; they die after <span class="math notranslate nohighlight">\(q\)</span> lags.</p></li>
<li><p>MA processes will exhibit exponential decay in PACF and a cut-off in ACF</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plot_acf</span><span class="p">(</span><span class="n">monthly_temp_clean</span><span class="p">[</span><span class="s1">&#39;Seasonally_Differenced&#39;</span><span class="p">],</span> <span class="n">lags</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">);</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/d258163cca6cacc579b030fb30db79df467f7a8aca83c3f957f1841a665674a4.png" src="../../_images/d258163cca6cacc579b030fb30db79df467f7a8aca83c3f957f1841a665674a4.png" />
</div>
</div>
<ul class="simple">
<li><p>As for the PACF, there are non-zero autocorrelations at lags 1 and 3.</p></li>
<li><p>So, the values to try are <span class="math notranslate nohighlight">\(q=1\)</span>, <span class="math notranslate nohighlight">\(q=2\)</span>, or <span class="math notranslate nohighlight">\(q=3\)</span>.</p></li>
</ul>
</section>
</section>
<section id="model-estimation">
<h3>Model estimation<a class="headerlink" href="#model-estimation" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Once the orders <span class="math notranslate nohighlight">\(p\)</span> and <span class="math notranslate nohighlight">\(q\)</span> are identified, it’s time to estimate the parameters <span class="math notranslate nohighlight">\(\phi_1, \dots, \phi_p\)</span> or the AR part the the parameters <span class="math notranslate nohighlight">\(\theta_1, \dots, \theta_q\)</span> of the MA part.</p></li>
<li><p>Estimating the parameters of an ARMA model is a complicated, nonlinear problem.</p></li>
<li><p>Nonlinear least squares and maximum likelihood e stimation (MLE) are common approaches.</p></li>
<li><p>Many modern software programs will fit the ARMA model for you.</p></li>
</ul>
<ul class="simple">
<li><p>We split the data in two parts:</p>
<ul>
<li><p>the training set, that will be used to fit the model’s parameters.</p></li>
<li><p>the test set, that will be used later on to evaluate the prediction performance of the model on unseen data.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span> <span class="o">=</span> <span class="n">monthly_temp_clean</span><span class="p">[</span><span class="s1">&#39;Seasonally_Differenced&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">36</span><span class="p">]</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">monthly_temp_clean</span><span class="p">[</span><span class="s1">&#39;Seasonally_Differenced&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">36</span><span class="p">:]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/4adfedb1f69b22bcd0e8bb88e2c34e84ee4ddb4fc1b2ba593855766c15b7bfc2.png" src="../../_images/4adfedb1f69b22bcd0e8bb88e2c34e84ee4ddb4fc1b2ba593855766c15b7bfc2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">ARIMA</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># ARIMA with d=0 is equivalent to ARMA</span>
<span class="n">fit_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">fit_model</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/filippo/miniconda3/envs/sta2003/lib/python3.10/site-packages/statsmodels/tsa/base/tsa_model.py:473: ValueWarning: No frequency information was provided, so inferred frequency MS will be used.
  self._init_dates(dates, freq)
/home/filippo/miniconda3/envs/sta2003/lib/python3.10/site-packages/statsmodels/tsa/base/tsa_model.py:473: ValueWarning: No frequency information was provided, so inferred frequency MS will be used.
  self._init_dates(dates, freq)
/home/filippo/miniconda3/envs/sta2003/lib/python3.10/site-packages/statsmodels/tsa/base/tsa_model.py:473: ValueWarning: No frequency information was provided, so inferred frequency MS will be used.
  self._init_dates(dates, freq)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                 SARIMAX Results                                  
==================================================================================
Dep. Variable:     Seasonally_Differenced   No. Observations:                  744
Model:                     ARIMA(3, 0, 3)   Log Likelihood               -2248.122
Date:                    Sat, 13 Apr 2024   AIC                           4512.244
Time:                            01:45:26   BIC                           4549.140
Sample:                        01-01-1908   HQIC                          4526.466
                             - 12-01-1969                                         
Covariance Type:                      opg                                         
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
const          0.0642      0.242      0.265      0.791      -0.411       0.539
ar.L1         -0.0878      0.146     -0.603      0.547      -0.373       0.198
ar.L2         -0.8306      0.024    -35.297      0.000      -0.877      -0.784
ar.L3          0.0469      0.127      0.370      0.711      -0.201       0.295
ma.L1          0.2732      0.145      1.888      0.059      -0.010       0.557
ma.L2          0.9956      0.012     81.915      0.000       0.972       1.019
ma.L3          0.2291      0.145      1.582      0.114      -0.055       0.513
sigma2        24.3460      1.010     24.099      0.000      22.366      26.326
===================================================================================
Ljung-Box (L1) (Q):                   0.01   Jarque-Bera (JB):                58.25
Prob(Q):                              0.92   Prob(JB):                         0.00
Heteroskedasticity (H):               0.77   Skew:                             0.11
Prob(H) (two-sided):                  0.04   Kurtosis:                         4.35
===================================================================================

Warnings:
[1] Covariance matrix calculated using the outer product of gradients (complex-step).
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/filippo/miniconda3/envs/sta2003/lib/python3.10/site-packages/statsmodels/base/model.py:607: ConvergenceWarning: Maximum Likelihood optimization failed to converge. Check mle_retvals
  warnings.warn(&quot;Maximum Likelihood optimization failed to &quot;
</pre></div>
</div>
</div>
</div>
</section>
<section id="arma-model-validation">
<h3>ARMA Model Validation<a class="headerlink" href="#arma-model-validation" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>How do you know if your ARMA model is any good?</p></li>
<li><p>We can check the resiudals, i.e., the parts the model was not able to fit.</p></li>
<li><p>The residuals should approximate a Gaussian distribution (aka white noise).</p></li>
<li><p>Otherwise, we might need to select a better model.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">residuals</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">resid</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Residuals&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/1d298f25b5b49aba0042a299bf82902af29b50014778499dfa02a6148f613ad5.png" src="../../_images/1d298f25b5b49aba0042a299bf82902af29b50014778499dfa02a6148f613ad5.png" />
</div>
</div>
<p><strong>🤔 How to test if the residuals look like noise?</strong></p>
<ul class="simple">
<li><p>We will use both visual inspection and statistical tests.</p></li>
<li><p>Visual inspection:</p>
<ul>
<li><p>ACF plot</p></li>
<li><p>Histogram</p></li>
<li><p>QQ plot</p></li>
</ul>
</li>
<li><p>Statistical tests:</p>
<ul>
<li><p>Normality</p></li>
<li><p>Autocorrelation</p></li>
<li><p>Heteroskedasticity</p></li>
</ul>
</li>
</ul>
<section id="visual-inspection">
<h4>Visual inspection<a class="headerlink" href="#visual-inspection" title="Link to this heading">#</a></h4>
<p><strong>ACF plot</strong></p>
<ul class="simple">
<li><p>Checks for any autocorrelation in the residuals.</p></li>
<li><p>White noise should show no significant autocorrelation at all lags.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plot_acf</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ACF of Residuals&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/c68db0ea0547fe14d35184395c265680c0cf0aa2c4ec34501394a89f70b9ca3c.png" src="../../_images/c68db0ea0547fe14d35184395c265680c0cf0aa2c4ec34501394a89f70b9ca3c.png" />
</div>
</div>
<p><strong>Histogram and QQ-Plot</strong></p>
<ul class="simple">
<li><p>Assess the normality of the residuals.</p></li>
<li><p>White noise should ideally follow a normal distribution.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Histogram</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="c1"># Add the normal distribution curve</span>
<span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">residuals</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">residuals</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Fit Results: mu = </span><span class="si">%.2f</span><span class="s2">,  std = </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">residuals</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">residuals</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b93ba04539948be5613c954d2cf9b66606ec7dc093b6204237942ae2eada85e0.png" src="../../_images/b93ba04539948be5613c954d2cf9b66606ec7dc093b6204237942ae2eada85e0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># QQ-Plot</span>
<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">qqplot</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;QQ-Plot of Residuals&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b047b8cf0dfd871ded7eeb63b91bd7fbd88c8c5aca893cd0425edffc731706ae.png" src="../../_images/b047b8cf0dfd871ded7eeb63b91bd7fbd88c8c5aca893cd0425edffc731706ae.png" />
</div>
</div>
<ul class="simple">
<li><p>The plots are conveniently summarized in the function <code class="docutils literal notranslate"><span class="pre">plot_diagnostics()</span></code> that can be called on the fit model.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit_model</span><span class="o">.</span><span class="n">plot_diagnostics</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/3f76c6752161a82f340b248683d1ecf6b8034f6c929db7840797df6ebd57e1f3.png" src="../../_images/3f76c6752161a82f340b248683d1ecf6b8034f6c929db7840797df6ebd57e1f3.png" />
</div>
</div>
</section>
<section id="statistical-tests">
<h4>Statistical tests<a class="headerlink" href="#statistical-tests" title="Link to this heading">#</a></h4>
<p><strong>Normality: Jarque-Bera and Shapiro-Wilk tests</strong></p>
<blockquote>
<div><p><span class="math notranslate nohighlight">\(H_0\)</span>: the residuals are normally distributed.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">norm_val</span><span class="p">,</span> <span class="n">norm_p</span><span class="p">,</span> <span class="n">skew</span><span class="p">,</span> <span class="n">kurtosis</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">test_normality</span><span class="p">(</span><span class="s1">&#39;jarquebera&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Normality (Jarque-Bera) p-value:</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">norm_p</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normality (Jarque-Bera) p-value:0.000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shapiro_test</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">shapiro</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Normality (Shapiro-Wilk) p-value: </span><span class="si">{</span><span class="n">shapiro_test</span><span class="o">.</span><span class="n">pvalue</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normality (Shapiro-Wilk) p-value: 0.000
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>The small p-values allow us to reject <span class="math notranslate nohighlight">\(H_0\)</span>.</p></li>
<li><p>Conclusion: the residuals are <strong>not</strong> normally distributed.</p></li>
</ul>
<p><strong>📝 Note</strong></p>
<ul class="simple">
<li><p>For reference, let’s see what these tests say about data that are actually normally distributed.</p></li>
<li><p>Try executing the cell below multiple times and see how much the results changes each time.</p></li>
<li><p>These tests start to be reliable only for large sample sizes (<span class="math notranslate nohighlight">\(N&gt;5000\)</span>).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate random normal data</span>
<span class="n">normal_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">jb_test</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">jarque_bera</span><span class="p">(</span><span class="n">normal_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Normality (Jarque-Bera) p-value: </span><span class="si">{</span><span class="n">jb_test</span><span class="o">.</span><span class="n">pvalue</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">shapiro_test</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">shapiro</span><span class="p">(</span><span class="n">normal_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Normality (Shapiro-Wilk) p-value: </span><span class="si">{</span><span class="n">shapiro_test</span><span class="o">.</span><span class="n">pvalue</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Normality (Jarque-Bera) p-value: 0.811
Normality (Shapiro-Wilk) p-value: 0.938
</pre></div>
</div>
</div>
</div>
<p><strong>Autocorrelation: Ljung-Box Test</strong></p>
<blockquote>
<div><p><span class="math notranslate nohighlight">\(H_0\)</span>: the residuals are independently distributed (no autocorrelation).</p>
</div></blockquote>
<ul class="simple">
<li><p>There is a p-value for each lag.</p></li>
<li><p>Here we just take the mean, but one might also want to look at the at largest lag (<code class="docutils literal notranslate"><span class="pre">pval[-1]</span></code>).</p></li>
<li><p>It is also not always obvious to select how many lags should be used in the test…</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">statistic</span><span class="p">,</span> <span class="n">pval</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">test_serial_correlation</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ljungbox&#39;</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">10</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Ljung-Box p-value: </span><span class="si">{</span><span class="n">pval</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ljung-Box p-value: 0.360
</pre></div>
</div>
</div>
</div>
<p><strong>Autocorrelation: Durbin Watson</strong></p>
<ul class="simple">
<li><p>Tests autocorrelation in the residuals.</p></li>
<li><p>We want something between 1-3, 2 is ideal (no serial correlation).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">durbin_watson</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">stattools</span><span class="o">.</span><span class="n">durbin_watson</span><span class="p">(</span><span class="n">fit_model</span><span class="o">.</span><span class="n">filter_results</span><span class="o">.</span><span class="n">standardized_forecasts_error</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">loglikelihood_burn</span><span class="p">:])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Durbin-Watson: d=</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">durbin_watson</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Durbin-Watson: d=1.99
</pre></div>
</div>
</div>
</div>
<p><strong>Heteroskedasticity</strong></p>
<ul class="simple">
<li><p>Tests for change in variance between residuals.</p></li>
</ul>
<blockquote>
<div><p><span class="math notranslate nohighlight">\(H_0\)</span>: no heteroskedasticity.</p>
</div></blockquote>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(H_0\)</span> indicates different things based on the alternative <span class="math notranslate nohighlight">\(H_A\)</span>:</p>
<ul>
<li><p><span class="math notranslate nohighlight">\(H_A\)</span>: Increasing, <span class="math notranslate nohighlight">\(H_0\)</span> the variance is not decreasing throughout the series.</p></li>
<li><p><span class="math notranslate nohighlight">\(H_A\)</span>: Decreasing, <span class="math notranslate nohighlight">\(H_0\)</span> the variance is not increasing throughout the series.</p></li>
<li><p><span class="math notranslate nohighlight">\(H_A\)</span>: Two-sided (default), <span class="math notranslate nohighlight">\(H_0\)</span> the variance is not changing throughout the srries.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">pval</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">test_heteroskedasticity</span><span class="p">(</span><span class="s1">&#39;breakvar&#39;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;increasing&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;H_a: Increasing - pvalue:</span><span class="si">{</span><span class="n">pval</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>H_a: Increasing - pvalue:0.981
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">pval</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">test_heteroskedasticity</span><span class="p">(</span><span class="s1">&#39;breakvar&#39;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;decreasing&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;H_a: Decreasing - pvalue:</span><span class="si">{</span><span class="n">pval</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>H_a: Decreasing - pvalue:0.019
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">pval</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">test_heteroskedasticity</span><span class="p">(</span><span class="s1">&#39;breakvar&#39;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;H_a: Two-sided - pvalue:</span><span class="si">{</span><span class="n">pval</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>H_a: Two-sided - pvalue:0.038
</pre></div>
</div>
</div>
</div>
<p><strong>Summary of our tests</strong></p>
<p>Independence</p>
<ul class="simple">
<li><p>✅ ACF plot</p></li>
<li><p>✅ Ljung-Box test</p></li>
<li><p>✅ Durbin Watson</p></li>
</ul>
<p>Normality:</p>
<ul class="simple">
<li><p>✅ Histogram/Density plot</p></li>
<li><p>🤔 QQ-plot</p></li>
<li><p>❌ Jarque-Bera (reliable for large sample size)</p></li>
<li><p>❌ Shapiro-Wilk (reliable for large sample size)</p></li>
</ul>
<p>Heteroskedasticity</p>
<ul class="simple">
<li><p>❌ Heteroskedasticity test</p></li>
</ul>
<ul class="simple">
<li><p>The tests are a bit inconclusive.</p></li>
<li><p>There is no strong evidence that the model is either very good or very bad.</p></li>
<li><p>It is probably wise to try other canidate models (e.g., ARMA(2,0,2)) and repeat the tests.</p></li>
</ul>
</section>
</section>
<section id="arma-model-predictions">
<h3>ARMA Model Predictions<a class="headerlink" href="#arma-model-predictions" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Once the model is fit, we can use it to predict the test data.</p></li>
<li><p>The prediction provides a distribution.</p></li>
<li><p>The mean (mode) of this distribution correspond to the most likely value and correspond to our forecast</p></li>
<li><p>The rest of the distribution can be used to compute confidence intervals</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_summary</span> <span class="o">=</span> <span class="n">fit_model</span><span class="o">.</span><span class="n">get_prediction</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">summary_frame</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pred_summary</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Forecast&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pred_summary</span><span class="p">[</span><span class="s1">&#39;mean_ci_lower&#39;</span><span class="p">],</span> <span class="n">pred_summary</span><span class="p">[</span><span class="s1">&#39;mean_ci_upper&#39;</span><span class="p">],</span> 
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95% Confidence Interval&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/14b2337fbc22344fd464b0f0a2b2a02625f5695fae1c3d93445f7b136441fe5f.png" src="../../_images/14b2337fbc22344fd464b0f0a2b2a02625f5695fae1c3d93445f7b136441fe5f.png" />
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="arima-model">
<h2>ARIMA Model<a class="headerlink" href="#arima-model" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>ARIMA stands for Auto Regressive Integrated Moving Average.</p></li>
<li><p>ARIMA models have three components:</p>
<ul>
<li><p>AR model</p></li>
<li><p>Integrated component (more on this shortly)</p></li>
<li><p>MA model</p></li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p>The ARIMA model is denoted ARIMA(<span class="math notranslate nohighlight">\(p, d, q\)</span>).</p>
<ul>
<li><p><span class="math notranslate nohighlight">\(p\)</span> is the order of the AR model.</p></li>
<li><p><span class="math notranslate nohighlight">\(d\)</span> is the number of times to difference the data.</p></li>
<li><p><span class="math notranslate nohighlight">\(q\)</span> is the order of the MA model.</p></li>
<li><p><span class="math notranslate nohighlight">\(p\)</span>, <span class="math notranslate nohighlight">\(d\)</span>, and <span class="math notranslate nohighlight">\(q\)</span> are nonnegative integers.</p></li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p>As we saw previously, differencing nonstationary time series data one or more times can make it stationary.</p></li>
<li><p>That’s the role of the integrated (I) component of ARIMA.</p></li>
<li><p><span class="math notranslate nohighlight">\(d\)</span> is the number of times to perform a lag 1 difference on the data.</p>
<ul>
<li><p><span class="math notranslate nohighlight">\(d=0\)</span>: no differencing.</p></li>
<li><p><span class="math notranslate nohighlight">\(d=1\)</span>: difference once.</p></li>
<li><p><span class="math notranslate nohighlight">\(d=2\)</span>: difference twice.</p></li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p>The ARMA model is suitable for the stationary series where the mean and variance do not change over time.</p></li>
<li><p>The ARIMA model effectively models the non-stationary series by differencing the data.</p></li>
<li><p>This, transforms it into a stationary series before applying the ARMA modeling steps.</p></li>
<li><p>Let’s see it with an example.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate synthetic stationary data with an ARMA(1,1) process</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">250</span>
<span class="n">ar_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7</span><span class="p">])</span> <span class="c1"># The first value refers to lag 0 and is always 1. In addition, AR coeff are negated.</span>
<span class="n">ma_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>  <span class="c1"># The first value refers to lag 0 and is always 1</span>
<span class="n">arma_data</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">arima_process</span><span class="o">.</span><span class="n">ArmaProcess</span><span class="p">(</span><span class="n">ar_params</span><span class="p">,</span> <span class="n">ma_params</span><span class="p">)</span><span class="o">.</span><span class="n">generate_sample</span><span class="p">(</span><span class="n">nsample</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate a synthetic non-stationary data (needs to be differenced twice to be stationary)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">non_stationary_data</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">t</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">arma_data</span>  <span class="c1"># Quadratic trend</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">non_stationary_data</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original Data&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">diff</span><span class="p">(</span><span class="n">non_stationary_data</span><span class="p">,</span> <span class="n">k_diff</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;1st Differencing&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">diff</span><span class="p">(</span><span class="n">non_stationary_data</span><span class="p">,</span> <span class="n">k_diff</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;2nd Differencing&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/e1af618d64e2f2e8eaa6464dce1934bf65cb8fe284e2bd54287e4512aa984f32.png" src="../../_images/e1af618d64e2f2e8eaa6464dce1934bf65cb8fe284e2bd54287e4512aa984f32.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit models to stationary data</span>
<span class="n">arma_model</span> <span class="o">=</span> <span class="n">ARIMA</span><span class="p">(</span><span class="n">arma_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">20</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">arima_model</span> <span class="o">=</span> <span class="n">ARIMA</span><span class="p">(</span><span class="n">arma_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">20</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">arma_data</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">:],</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Stationary Data&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">arma_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">250</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ARMA Fit&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">arima_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">250</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ARIMA Fit&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Stationary Data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arma_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>220
</pre></div>
</div>
<img alt="../../_images/117034a67e71a0fe19f8b67b7dbf970021229daf918125123f18df507c69c3c3.png" src="../../_images/117034a67e71a0fe19f8b67b7dbf970021229daf918125123f18df507c69c3c3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit models to non-stationary data</span>
<span class="n">arma_model</span> <span class="o">=</span> <span class="n">ARIMA</span><span class="p">(</span><span class="n">non_stationary_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">20</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">arima_model</span> <span class="o">=</span> <span class="n">ARIMA</span><span class="p">(</span><span class="n">non_stationary_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">20</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">non_stationary_data</span><span class="p">[</span><span class="o">-</span><span class="mi">40</span><span class="p">:],</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Non-stationary Data&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">arma_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="mi">210</span><span class="p">,</span><span class="mi">250</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ARMA Fit&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">arima_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="mi">210</span><span class="p">,</span><span class="mi">250</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ARIMA Fit&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Non-stationary Data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/72ce0dcfa05b95ad93e186dd568d309ec4167aad6e8155c5c3e352e7f45bcb5a.png" src="../../_images/72ce0dcfa05b95ad93e186dd568d309ec4167aad6e8155c5c3e352e7f45bcb5a.png" />
</div>
</div>
</section>
<hr class="docutils" />
<section id="sarima">
<h2>SARIMA<a class="headerlink" href="#sarima" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>To apply ARMA and ARIMA, we had to remove the seasonal component.</p></li>
<li><p>After computing the predictions, we had to put the seasonal component back.</p></li>
<li><p>It would be convenient to directly work on data with seasonality.</p></li>
</ul>
<ul class="simple">
<li><p>SARIMA is an extension of ARIMA that includes seasonal terms.</p></li>
<li><p>The model is specified as SARIMA <span class="math notranslate nohighlight">\((p, d, q) \times (P, D, Q, s)\)</span>:</p>
<ul>
<li><p>Regular ARIMA components <span class="math notranslate nohighlight">\((p, d, q)\)</span>.</p></li>
<li><p>Seasonal components <span class="math notranslate nohighlight">\((P, D, Q, s)\)</span> where:</p>
<ul>
<li><p><span class="math notranslate nohighlight">\(P\)</span>: Seasonal autoregressive order.</p></li>
<li><p><span class="math notranslate nohighlight">\(D\)</span>: Seasonal differencing order.</p></li>
<li><p><span class="math notranslate nohighlight">\(Q\)</span>: Seasonal moving average order.</p></li>
<li><p><span class="math notranslate nohighlight">\(s\)</span>: Number of time steps for a single seasonal period.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>How to select the SARIMA  parameters <span class="math notranslate nohighlight">\(s, P, D, Q\)</span>?</strong></p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(s\)</span>:</p>
<ul>
<li><p>Is the main seasonality in the data.</p></li>
<li><p>We’ve seen already how to detect it.</p></li>
</ul>
</li>
<li><p><span class="math notranslate nohighlight">\(P\)</span> and <span class="math notranslate nohighlight">\(Q\)</span>:</p>
<ul>
<li><p>A bar at <span class="math notranslate nohighlight">\(s\)</span>-th lag (and potentially multiples of <span class="math notranslate nohighlight">\(s\)</span>) should be present.</p></li>
<li><p>For example, if <span class="math notranslate nohighlight">\(s = 12\)</span>, there could be bars at <span class="math notranslate nohighlight">\((s*n)^{th}\)</span> lags too.</p></li>
<li><p>Pick out the few lags of largest values as candidates for <span class="math notranslate nohighlight">\(P\)</span> or <span class="math notranslate nohighlight">\(Q\)</span>.</p></li>
</ul>
</li>
<li><p><span class="math notranslate nohighlight">\(D\)</span>:</p>
<ul>
<li><p>Is the number of seasonal differencing required to make the series stationary.</p></li>
<li><p>Often determined by trial and error, or by examining the seasonally differenced data.</p></li>
</ul>
</li>
</ul>
<p><strong>💡 Rule of thumb</strong></p>
<ul class="simple">
<li><p>Before selecting <span class="math notranslate nohighlight">\(P\)</span> and <span class="math notranslate nohighlight">\(Q\)</span>, ensure that the series is seasonally stationary by applying seasonal differencing if needed (<span class="math notranslate nohighlight">\(D\)</span>).</p></li>
<li><p>Look the ACF plot to identify the seasonal moving average order <span class="math notranslate nohighlight">\(Q\)</span>.</p>
<ul>
<li><p>Look for significant autocorrelations at seasonal lags (multiples of <span class="math notranslate nohighlight">\(s\)</span>).</p></li>
<li><p>If the ACF plot shows a slow decay in the seasonal lags, it suggests a need for a seasonal MA component (<span class="math notranslate nohighlight">\(Q\)</span>).</p></li>
</ul>
</li>
<li><p>Look at tge PACF plot to identify the seasonal autoregressive order <span class="math notranslate nohighlight">\(P\)</span>.</p>
<ul>
<li><p>Look for significant spikes at multiples of the seasonality <span class="math notranslate nohighlight">\(s\)</span>.</p></li>
<li><p>A sharp cut-off in the PACF at a seasonal lag suggests the number of AR terms (<span class="math notranslate nohighlight">\(P\)</span>) needed.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff_ts</span> <span class="o">=</span> <span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">periods</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">diff_ts</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">plot_pacf</span><span class="p">(</span><span class="n">diff_ts</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">plot_acf</span><span class="p">(</span><span class="n">diff_ts</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/79a53a1a4427d8cb808bd9fdc15643d6814bd7627127184c78d1c215582260e7.png" src="../../_images/79a53a1a4427d8cb808bd9fdc15643d6814bd7627127184c78d1c215582260e7.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fit SARIMA monthly based on helper plots</span>
<span class="n">sar</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">tsa</span><span class="o">.</span><span class="n">statespace</span><span class="o">.</span><span class="n">sarimax</span><span class="o">.</span><span class="n">SARIMAX</span><span class="p">(</span><span class="n">monthly_temp</span><span class="p">[:</span><span class="mi">750</span><span class="p">]</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> 
                                <span class="n">order</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> 
                                <span class="n">seasonal_order</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> 
                                <span class="n">trend</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sar</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/filippo/miniconda3/envs/sta2003/lib/python3.10/site-packages/statsmodels/tsa/base/tsa_model.py:473: ValueWarning: No frequency information was provided, so inferred frequency MS will be used.
  self._init_dates(dates, freq)
/home/filippo/miniconda3/envs/sta2003/lib/python3.10/site-packages/statsmodels/tsa/base/tsa_model.py:473: ValueWarning: No frequency information was provided, so inferred frequency MS will be used.
  self._init_dates(dates, freq)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/filippo/miniconda3/envs/sta2003/lib/python3.10/site-packages/statsmodels/base/model.py:607: ConvergenceWarning: Maximum Likelihood optimization failed to converge. Check mle_retvals
  warnings.warn(&quot;Maximum Likelihood optimization failed to &quot;
</pre></div>
</div>
<div class="output text_html"><table class="simpletable">
<caption>SARIMAX Results</caption>
<tr>
  <th>Dep. Variable:</th>                 <td>temp</td>               <th>  No. Observations:  </th>    <td>750</td>   
</tr>
<tr>
  <th>Model:</th>           <td>SARIMAX(2, 1, 2)x(0, 1, [1], 12)</td> <th>  Log Likelihood     </th> <td>-2026.036</td>
</tr>
<tr>
  <th>Date:</th>                    <td>Sat, 13 Apr 2024</td>         <th>  AIC                </th> <td>4066.071</td> 
</tr>
<tr>
  <th>Time:</th>                        <td>01:45:29</td>             <th>  BIC                </th> <td>4098.290</td> 
</tr>
<tr>
  <th>Sample:</th>                     <td>01-01-1907</td>            <th>  HQIC               </th> <td>4078.496</td> 
</tr>
<tr>
  <th></th>                           <td>- 06-01-1969</td>           <th>                     </th>     <td> </td>    
</tr>
<tr>
  <th>Covariance Type:</th>                <td>opg</td>               <th>                     </th>     <td> </td>    
</tr>
</table>
<table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P>|z|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>intercept</th> <td>-6.727e-05</td> <td>    0.000</td> <td>   -0.376</td> <td> 0.707</td> <td>   -0.000</td> <td>    0.000</td>
</tr>
<tr>
  <th>ar.L1</th>     <td>   -0.7678</td> <td>    0.246</td> <td>   -3.122</td> <td> 0.002</td> <td>   -1.250</td> <td>   -0.286</td>
</tr>
<tr>
  <th>ar.L2</th>     <td>    0.1779</td> <td>    0.050</td> <td>    3.529</td> <td> 0.000</td> <td>    0.079</td> <td>    0.277</td>
</tr>
<tr>
  <th>ma.L1</th>     <td>   -0.0504</td> <td>    0.259</td> <td>   -0.195</td> <td> 0.845</td> <td>   -0.557</td> <td>    0.456</td>
</tr>
<tr>
  <th>ma.L2</th>     <td>   -0.9476</td> <td>    0.248</td> <td>   -3.822</td> <td> 0.000</td> <td>   -1.434</td> <td>   -0.462</td>
</tr>
<tr>
  <th>ma.S.L12</th>  <td>   -0.9825</td> <td>    0.041</td> <td>  -23.883</td> <td> 0.000</td> <td>   -1.063</td> <td>   -0.902</td>
</tr>
<tr>
  <th>sigma2</th>    <td>   13.3607</td> <td>    1.066</td> <td>   12.534</td> <td> 0.000</td> <td>   11.271</td> <td>   15.450</td>
</tr>
</table>
<table class="simpletable">
<tr>
  <th>Ljung-Box (L1) (Q):</th>     <td>0.05</td> <th>  Jarque-Bera (JB):  </th> <td>204.55</td>
</tr>
<tr>
  <th>Prob(Q):</th>                <td>0.82</td> <th>  Prob(JB):          </th>  <td>0.00</td> 
</tr>
<tr>
  <th>Heteroskedasticity (H):</th> <td>0.77</td> <th>  Skew:              </th>  <td>-0.55</td>
</tr>
<tr>
  <th>Prob(H) (two-sided):</th>    <td>0.04</td> <th>  Kurtosis:          </th>  <td>5.33</td> 
</tr>
</table><br/><br/>Warnings:<br/>[1] Covariance matrix calculated using the outer product of gradients (complex-step).</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sar</span><span class="o">.</span><span class="n">plot_diagnostics</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/dd470272ab432eb81b250558e153034ccde7d6d10ce448fbda2dbfb461624aec.png" src="../../_images/dd470272ab432eb81b250558e153034ccde7d6d10ce448fbda2dbfb461624aec.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;forecast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sar</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="mi">750</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span> <span class="mi">792</span><span class="p">,</span> <span class="n">dynamic</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
<span class="n">monthly_temp</span><span class="p">[</span><span class="mi">730</span><span class="p">:][[</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="s1">&#39;forecast&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MSE: </span><span class="si">{</span><span class="n">mse</span><span class="p">(</span><span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">42</span><span class="p">:],</span><span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;forecast&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">42</span><span class="p">:])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MSE: 9.23
</pre></div>
</div>
<img alt="../../_images/609d0ef69c32f1a53045e500d6534dc0cfac8abd5629db4fb4af5181dda2187a.png" src="../../_images/609d0ef69c32f1a53045e500d6534dc0cfac8abd5629db4fb4af5181dda2187a.png" />
</div>
</div>
</section>
<section id="autoarima">
<h2>AutoARIMA<a class="headerlink" href="#autoarima" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>At this point it should be clear that indetifying the coefficients is a difficult task.</p></li>
<li><p>It requires careful analysis, trial and errors, and some experience.</p></li>
<li><p>The following cheatsheet summarizes some rules of thumbs to select the model.</p></li>
</ul>
<p><strong>💡 Cheatsheet: coefficients setting</strong></p>
<center>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>ACF Shape</p></th>
<th class="head text-left"><p>Indicated Model</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Exponential, decaying to zero</p></td>
<td class="text-left"><p>AR model. Use the PACF to identify the order of the ARe model.</p></td>
</tr>
<tr class="row-odd"><td><p>Alternating positive and negative, decaying to zero</p></td>
<td class="text-left"><p>AR model. Use the PACF to identify the order.</p></td>
</tr>
<tr class="row-even"><td><p>One or more spikes, rest are essentially zero</p></td>
<td class="text-left"><p>MA model, order identified by where plot becomes zero.</p></td>
</tr>
<tr class="row-odd"><td><p>Decay, starting after a few lags</p></td>
<td class="text-left"><p>Mixed AR and MA (ARMA) model.</p></td>
</tr>
<tr class="row-even"><td><p>All zero or close to zero</p></td>
<td class="text-left"><p>Data are essentially random.</p></td>
</tr>
<tr class="row-odd"><td><p>High values at fixed intervals</p></td>
<td class="text-left"><p>Include seasonal AR term.</p></td>
</tr>
<tr class="row-even"><td><p>No decay to zero</p></td>
<td class="text-left"><p>Series is not stationary.</p></td>
</tr>
</tbody>
</table>
</center><ul class="simple">
<li><p>An alternative to manual model selection is to use automated procedure.</p></li>
<li><p>Here enters AutoARIMA.</p></li>
<li><p>AutoARIMA requires you to specify the maximum range of values to try.</p></li>
<li><p>Afterwards, it tries to find the best confgiuration among the possible ones.</p></li>
<li><p>See <a class="reference external" href="https://alkaline-ml.com/pmdarima/modules/generated/pmdarima.arima.auto_arima.html">here</a> for a complete list and description of the options available.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split the data into train and test sets</span>
<span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">monthly_temp</span><span class="p">[:</span><span class="mi">750</span><span class="p">]</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">monthly_temp</span><span class="p">[</span><span class="mi">750</span><span class="p">:]</span><span class="o">.</span><span class="n">temp</span>

<span class="c1"># Use auto_arima to find the best ARIMA model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">auto_arima</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> 
                      <span class="n">start_p</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_q</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">test</span><span class="o">=</span><span class="s1">&#39;adf&#39;</span><span class="p">,</span>       <span class="c1"># Use adftest to find optimal &#39;d&#39;</span>
                      <span class="n">max_p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_q</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="c1"># Maximum p and q</span>
                      <span class="n">m</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>             <span class="c1"># Seasonality</span>
                      <span class="n">start_P</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_Q</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">max_P</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_Q</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="c1"># Maximum p and q</span>
                      <span class="n">seasonal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>    <span class="c1"># Seasonal ARIMA</span>
                      <span class="n">d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>           <span class="c1"># Let model determine &#39;d&#39;</span>
                      <span class="n">D</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>              <span class="c1"># Seasonal difference</span>
                      <span class="n">trace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>       <span class="c1"># Print status on the fits</span>
                      <span class="n">error_action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span>  
                      <span class="n">suppress_warnings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                      <span class="n">stepwise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    <span class="c1"># Stepwise search to find the best model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Performing stepwise search to minimize aic
 ARIMA(0,0,0)(0,1,0)[12] intercept   : AIC=4558.569, Time=0.02 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(1,0,0)(1,1,0)[12] intercept   : AIC=4318.918, Time=0.17 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(0,0,1)(0,1,1)[12] intercept   : AIC=inf, Time=0.60 sec
 ARIMA(0,0,0)(0,1,0)[12]             : AIC=4556.588, Time=0.02 sec
 ARIMA(1,0,0)(0,1,0)[12] intercept   : AIC=4531.290, Time=0.05 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(1,0,0)(2,1,0)[12] intercept   : AIC=4230.055, Time=0.72 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(1,0,0)(2,1,1)[12] intercept   : AIC=inf, Time=1.33 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(1,0,0)(1,1,1)[12] intercept   : AIC=inf, Time=0.43 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(0,0,0)(2,1,0)[12] intercept   : AIC=4256.241, Time=0.48 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(2,0,0)(2,1,0)[12] intercept   : AIC=4230.500, Time=0.83 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(1,0,1)(2,1,0)[12] intercept   : AIC=4228.386, Time=0.94 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(1,0,1)(1,1,0)[12] intercept   : AIC=4317.592, Time=0.27 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(1,0,1)(2,1,1)[12] intercept   : AIC=inf, Time=1.94 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(1,0,1)(1,1,1)[12] intercept   : AIC=inf, Time=0.68 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(0,0,1)(2,1,0)[12] intercept   : AIC=4232.657, Time=0.58 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(2,0,1)(2,1,0)[12] intercept   : AIC=4230.040, Time=1.43 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(1,0,2)(2,1,0)[12] intercept   : AIC=4229.928, Time=0.94 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(0,0,2)(2,1,0)[12] intercept   : AIC=4232.612, Time=0.73 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(2,0,2)(2,1,0)[12] intercept   : AIC=4231.411, Time=1.51 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(1,0,1)(2,1,0)[12]             : AIC=4226.467, Time=0.39 sec
 ARIMA(1,0,1)(1,1,0)[12]             : AIC=4315.652, Time=0.14 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(1,0,1)(2,1,1)[12]             : AIC=inf, Time=1.59 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(1,0,1)(1,1,1)[12]             : AIC=inf, Time=0.40 sec
 ARIMA(0,0,1)(2,1,0)[12]             : AIC=4230.780, Time=0.18 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(1,0,0)(2,1,0)[12]             : AIC=4228.164, Time=0.21 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(2,0,1)(2,1,0)[12]             : AIC=4228.121, Time=0.58 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(1,0,2)(2,1,0)[12]             : AIC=4228.009, Time=0.27 sec
 ARIMA(0,0,0)(2,1,0)[12]             : AIC=4254.407, Time=0.17 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(0,0,2)(2,1,0)[12]             : AIC=4230.723, Time=0.27 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(2,0,0)(2,1,0)[12]             : AIC=4228.598, Time=0.27 sec
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> ARIMA(2,0,2)(2,1,0)[12]             : AIC=4229.492, Time=0.65 sec

Best model:  ARIMA(1,0,1)(2,1,0)[12]          
Total fit time: 18.811 seconds
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Summarize the model</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

<span class="c1"># Frecast future values</span>
<span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;forecast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">n_periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">))</span> 
<span class="n">monthly_temp</span><span class="p">[</span><span class="mi">730</span><span class="p">:][[</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="s1">&#39;forecast&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MSE: </span><span class="si">{</span><span class="n">mse</span><span class="p">(</span><span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">42</span><span class="p">:],</span><span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;forecast&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">42</span><span class="p">:])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                      SARIMAX Results                                      
===========================================================================================
Dep. Variable:                                   y   No. Observations:                  750
Model:             SARIMAX(1, 0, 1)x(2, 1, [], 12)   Log Likelihood               -2108.234
Date:                             Sat, 13 Apr 2024   AIC                           4226.467
Time:                                     01:45:48   BIC                           4249.487
Sample:                                 01-01-1907   HQIC                          4235.344
                                      - 06-01-1969                                         
Covariance Type:                               opg                                         
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
ar.L1          0.5814      0.144      4.027      0.000       0.298       0.864
ma.L1         -0.4101      0.162     -2.528      0.011      -0.728      -0.092
ar.S.L12      -0.6818      0.029    -23.405      0.000      -0.739      -0.625
ar.S.L24      -0.3479      0.030    -11.737      0.000      -0.406      -0.290
sigma2        17.5740      0.668     26.315      0.000      16.265      18.883
===================================================================================
Ljung-Box (L1) (Q):                   0.03   Jarque-Bera (JB):               145.56
Prob(Q):                              0.87   Prob(JB):                         0.00
Heteroskedasticity (H):               0.76   Skew:                            -0.39
Prob(H) (two-sided):                  0.04   Kurtosis:                         5.03
===================================================================================

Warnings:
[1] Covariance matrix calculated using the outer product of gradients (complex-step).
MSE: 11.12
</pre></div>
</div>
<img alt="../../_images/4580167b2ef8032ed27672564dc5ee2b5c7d9c4a3c2c6f666726ca3f9a9f1bd2.png" src="../../_images/4580167b2ef8032ed27672564dc5ee2b5c7d9c4a3c2c6f666726ca3f9a9f1bd2.png" />
</div>
</div>
<section id="autoarima-or-not-autoarima">
<h3>AutoARIMA or not AutoARIMA?<a class="headerlink" href="#autoarima-or-not-autoarima" title="Link to this heading">#</a></h3>
<p>While being very convenient, like all automated procedures <code class="docutils literal notranslate"><span class="pre">auto_arima</span></code> comes with drawbacks.</p>
<ol class="arabic simple">
<li><p><strong>Computational Cost</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">auto_arima</span></code> can be computationally expensive, especially for large datasets and when exploring a wide range of model parameters.</p></li>
</ul>
</li>
</ol>
<ol class="arabic simple" start="2">
<li><p><strong>Lack of Domain Insight</strong></p>
<ul class="simple">
<li><p>Automated model selection lacks the qualitative insights a human might bring to the modeling process, such as understanding business cycles, external factors, or anomalies in the data.</p></li>
<li><p>These insights can be crucial for selecting the appropriate model, especially with limited data.</p></li>
</ul>
</li>
</ol>
<ol class="arabic simple" start="3">
<li><p><strong>Default Settings and Assumptions</strong></p>
<ul class="simple">
<li><p>The defaults in <code class="docutils literal notranslate"><span class="pre">auto_arima</span></code> may not be optimal for all time series data.</p></li>
<li><p>The choice of stationarity tests, seasonal tests, and the range of parameters explored should be adjusted properly for each context.</p></li>
<li><p>This might become almost as complicated as doing manual model selection.</p></li>
</ul>
</li>
</ol>
<ol class="arabic simple" start="4">
<li><p><strong>Data Requirements</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">auto_arima</span></code> requires a sufficiently long time series to accurately identify patterns and seasonality.</p></li>
<li><p>For very short time series, the model selection process may not be reliable.</p></li>
</ul>
</li>
</ol>
<ol class="arabic simple" start="5">
<li><p><strong>Statistical Criteria Limitations</strong></p>
<ul class="simple">
<li><p>The selection of the best model is typically based on statistical criteria such as AIC or BIC, which might not always align with practical performance metrics such as forecast accuracy.</p></li>
</ul>
</li>
</ol>
</section>
</section>
<section id="grid-search">
<h2>Grid Search<a class="headerlink" href="#grid-search" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Selecting the best ARIMA model is as much an art as it is a science, involving iteration and refinement.</p></li>
<li><p>A common approach is to select a set of candidates for the parameters <span class="math notranslate nohighlight">\((p,d,q)\times (P,D,Q,s)\)</span> and fit a model for each possible combination.</p></li>
</ul>
<ul class="simple">
<li><p>For each fit model:</p>
<ul>
<li><p>Analyze the residuals using the visual techniques and the statistical tests discussed before</p></li>
<li><p>Evaluate the prediction performance. How?</p></li>
<li><p>Evaluate its complexity. How?</p></li>
</ul>
</li>
</ul>
<section id="prediction-performance">
<h3>Prediction performance<a class="headerlink" href="#prediction-performance" title="Link to this heading">#</a></h3>
<p>Use MSE and/or MAPE to evaluate the prediction performance of the model.</p>
<p><strong>Mean Squared Error (MSE)</strong></p>
<ul class="simple">
<li><p>MSE is the average of the squared differences between the observed values and the predictions.</p></li>
<li><p><span class="math notranslate nohighlight">\(MSE = \frac{1}{n}\sum_{i=1}^{n}(Y_i - \hat{Y}_i)^2\)</span>, where <span class="math notranslate nohighlight">\(Y_i\)</span> is the actual observation and <span class="math notranslate nohighlight">\(\hat{Y}_i\)</span> is the forecasted value.</p></li>
<li><p>In SARIMA model selection, a model with a lower MSE is preferred, indicating better fit to the data.</p></li>
</ul>
<p><strong>Mean Absolute Percentage Error (MAPE)</strong></p>
<ul class="simple">
<li><p>MAPE is the average of the absolute percentage errors of forecasts.</p></li>
<li><p><span class="math notranslate nohighlight">\(MAPE = \frac{100\%}{n}\sum_{i=1}^{n}\left|\frac{Y_i - \hat{Y}_i}{Y_i}\right|\)</span>, where <span class="math notranslate nohighlight">\(Y_i\)</span> is the actual observation and <span class="math notranslate nohighlight">\(\hat{Y}_i\)</span> is the forecasted value.</p></li>
<li><p>MAPE expresses errors as a percentage, making it straightforward to understand the magnitude of forecasting errors.</p></li>
<li><p>If you are comparing models that predict different quantities (e.g., dollars vs. units sold), the percentage error allows for a more apples-to-apples comparison.</p></li>
<li><p>Also, when you’re more interested in the relative size of the errors than in their absolute size, MAPE is relevant.</p></li>
<li><p>Finally, MAPE is useful when the magnitude of the data varies significantly.</p></li>
</ul>
</section>
<section id="model-complexity">
<h3>Model complexity<a class="headerlink" href="#model-complexity" title="Link to this heading">#</a></h3>
<p>Use AIC or BIC to estimate the model’s complexity.</p>
<p><strong>Akaike Information Criterion (AIC)</strong></p>
<ul class="simple">
<li><p>AIC is a measure of the relative quality of statistical models for a given set of data.</p></li>
<li><p>It deals with the trade-off between the goodness of fit of the model and the complexity of the model.</p></li>
<li><p><span class="math notranslate nohighlight">\(AIC = 2k - 2\ln(\hat{L})\)</span>, where <span class="math notranslate nohighlight">\(k\)</span> is the number of parameters in the model, and <span class="math notranslate nohighlight">\(\hat{L}\)</span> is the maximized value of the likelihood function for the model.</p></li>
<li><p>The model with the lowest AIC value is preferred, as it fits the data well but is not overly complex.</p></li>
</ul>
<p><strong>Bayesian Information Criterion (BIC)</strong></p>
<ul class="simple">
<li><p>Similar to AIC, the BIC is another criterion for model selection, but it introduces a stronger penalty for models with more parameters.</p></li>
<li><p><span class="math notranslate nohighlight">\(BIC = \ln(n)k - 2\ln(\hat{L})\)</span>, where <span class="math notranslate nohighlight">\(n\)</span> is the number of observations, <span class="math notranslate nohighlight">\(k\)</span> is the number of parameters, and <span class="math notranslate nohighlight">\(\hat{L}\)</span> is the maximized likelihood.</p></li>
<li><p>A lower BIC value indicates a better model, preferring simpler models to complex ones, especially as the sample size <span class="math notranslate nohighlight">\(n\)</span> increases.</p></li>
</ul>
</section>
<section id="restricting-the-search-with-exploratory-data-analysis-eda">
<h3>Restricting the search with Exploratory Data Analysis (EDA)<a class="headerlink" href="#restricting-the-search-with-exploratory-data-analysis-eda" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Grid search can be very expensive if done exaustively, especially on limited hardware.</p></li>
<li><p>An Exploratory Data Analysis can help to significantly reduce the number of candidates to try out.</p></li>
</ul>
<section id="selecting-the-candidates-for-differentiation">
<h4>Selecting the candidates for differentiation<a class="headerlink" href="#selecting-the-candidates-for-differentiation" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Let’s start by identifying all the candidates for seasonal and general differencing.</p></li>
<li><p>In this case, we already know that the main seasionality is <span class="math notranslate nohighlight">\(s=12\)</span>.</p></li>
<li><p>Should we apply first the general or the seasonal differencing?</p></li>
</ul>
<p><strong>💡 Hint</strong></p>
<ul class="simple">
<li><p>If seasonal patterns are dominant and the goal is to remove seasonality before addressing any trend, start with <strong>seasonal differencing</strong>.</p>
<ul>
<li><p>This is particularly useful when the seasonal pattern is strong and clear.</p></li>
</ul>
</li>
<li><p>If the trend is the predominant feature, you might start with <strong>standard differencing</strong>.</p></li>
</ul>
<ul class="simple">
<li><p>In our case, we go with seasonal differencing first.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create all combinations of differencing orders, applying seasonal differencing first and then general differencing</span>
<span class="k">def</span> <span class="nf">differencing</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">D_max</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">d_max</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        
    <span class="c1"># Seasonal differencing from 0 to D_max</span>
    <span class="n">seas_differenced</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D_max</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">timeseries</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;d0_D</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_s</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">seas_differenced</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>
        <span class="n">timeseries</span> <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">periods</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
    <span class="n">seas_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">seas_differenced</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># General differencing from 0 to d_max</span>
    <span class="n">general_differenced</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seas_differenced</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">d_max</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;d</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_D</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">_s</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">general_differenced</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>       
    <span class="n">gen_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">general_differenced</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    
    <span class="c1"># concatenate seasonal and general differencing dataframes</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">seas_df</span><span class="p">,</span> <span class="n">gen_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the differenced series</span>
<span class="n">diff_series</span> <span class="o">=</span> <span class="n">differencing</span><span class="p">(</span><span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">D_max</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">d_max</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">diff_series</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>d0_D0_s12</th>
      <th>d0_D1_s12</th>
      <th>d0_D2_s12</th>
      <th>d1_D0_s12</th>
      <th>d2_D0_s12</th>
      <th>d1_D1_s12</th>
      <th>d2_D1_s12</th>
      <th>d1_D2_s12</th>
      <th>d2_D2_s12</th>
    </tr>
    <tr>
      <th>month</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1907-01-01</th>
      <td>33.3</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1907-02-01</th>
      <td>46.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>12.7</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1907-03-01</th>
      <td>43.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-3.0</td>
      <td>-15.7</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1907-04-01</th>
      <td>55.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>12.0</td>
      <td>15.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1907-05-01</th>
      <td>51.8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-3.2</td>
      <td>-15.2</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1972-08-01</th>
      <td>75.6</td>
      <td>-4.9</td>
      <td>-4.9</td>
      <td>-3.4</td>
      <td>-10.3</td>
      <td>-2.3</td>
      <td>1.7</td>
      <td>1.1</td>
      <td>8.4</td>
    </tr>
    <tr>
      <th>1972-09-01</th>
      <td>64.1</td>
      <td>-1.7</td>
      <td>-2.5</td>
      <td>-11.5</td>
      <td>-8.1</td>
      <td>3.2</td>
      <td>5.5</td>
      <td>2.4</td>
      <td>1.3</td>
    </tr>
    <tr>
      <th>1972-10-01</th>
      <td>51.7</td>
      <td>0.6</td>
      <td>2.7</td>
      <td>-12.4</td>
      <td>-0.9</td>
      <td>2.3</td>
      <td>-0.9</td>
      <td>5.2</td>
      <td>2.8</td>
    </tr>
    <tr>
      <th>1972-11-01</th>
      <td>40.3</td>
      <td>-1.5</td>
      <td>3.4</td>
      <td>-11.4</td>
      <td>1.0</td>
      <td>-2.1</td>
      <td>-4.4</td>
      <td>0.7</td>
      <td>-4.5</td>
    </tr>
    <tr>
      <th>1972-12-01</th>
      <td>30.3</td>
      <td>-0.3</td>
      <td>3.2</td>
      <td>-10.0</td>
      <td>1.4</td>
      <td>1.2</td>
      <td>3.3</td>
      <td>-0.2</td>
      <td>-0.9</td>
    </tr>
  </tbody>
</table>
<p>792 rows × 9 columns</p>
</div></div></div>
</div>
</section>
<section id="filter-out-non-stationary-candidates">
<h4>Filter-out non-stationary candidates<a class="headerlink" href="#filter-out-non-stationary-candidates" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Among all the differenced time series, keep only those that are stationary (according to ADF)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a summary of test results of all the series</span>
<span class="k">def</span> <span class="nf">adf_summary</span><span class="p">(</span><span class="n">diff_series</span><span class="p">):</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">diff_series</span><span class="p">:</span>
        <span class="c1"># unpack the results</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">adfuller</span><span class="p">(</span><span class="n">diff_series</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>
        <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Test Statistic&quot;</span><span class="p">,</span> <span class="s2">&quot;p-value&quot;</span><span class="p">,</span> <span class="s2">&quot;#Lags Used&quot;</span><span class="p">,</span> <span class="s2">&quot;No. of Obs. Used&quot;</span><span class="p">,</span>
               <span class="s2">&quot;Critical Value (1%)&quot;</span><span class="p">,</span> <span class="s2">&quot;Critical Value (5%)&quot;</span><span class="p">,</span> <span class="s2">&quot;Critical Value (10%)&quot;</span><span class="p">]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">diff_series</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">summary</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create the summary</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">adf_summary</span><span class="p">(</span><span class="n">diff_series</span><span class="p">)</span>

<span class="c1"># filter away results that are not stationary</span>
<span class="n">summary_passed</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[</span><span class="n">summary</span><span class="p">[</span><span class="s2">&quot;p-value&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">]</span>
<span class="n">summary_passed</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Test Statistic</th>
      <th>p-value</th>
      <th>#Lags Used</th>
      <th>No. of Obs. Used</th>
      <th>Critical Value (1%)</th>
      <th>Critical Value (5%)</th>
      <th>Critical Value (10%)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>d0_D0_s12</th>
      <td>-6.481466</td>
      <td>1.291867e-08</td>
      <td>21</td>
      <td>770</td>
      <td>-3.438871</td>
      <td>-2.865301</td>
      <td>-2.568773</td>
    </tr>
    <tr>
      <th>d0_D1_s12</th>
      <td>-12.658082</td>
      <td>1.323220e-23</td>
      <td>12</td>
      <td>767</td>
      <td>-3.438905</td>
      <td>-2.865316</td>
      <td>-2.568781</td>
    </tr>
    <tr>
      <th>d0_D2_s12</th>
      <td>-10.416254</td>
      <td>1.751310e-18</td>
      <td>14</td>
      <td>753</td>
      <td>-3.439064</td>
      <td>-2.865386</td>
      <td>-2.568818</td>
    </tr>
    <tr>
      <th>d1_D0_s12</th>
      <td>-12.302613</td>
      <td>7.391771e-23</td>
      <td>21</td>
      <td>769</td>
      <td>-3.438882</td>
      <td>-2.865306</td>
      <td>-2.568775</td>
    </tr>
    <tr>
      <th>d2_D0_s12</th>
      <td>-15.935084</td>
      <td>7.651998e-29</td>
      <td>17</td>
      <td>772</td>
      <td>-3.438849</td>
      <td>-2.865291</td>
      <td>-2.568767</td>
    </tr>
    <tr>
      <th>d1_D1_s12</th>
      <td>-11.846173</td>
      <td>7.390517e-22</td>
      <td>20</td>
      <td>758</td>
      <td>-3.439006</td>
      <td>-2.865361</td>
      <td>-2.568804</td>
    </tr>
    <tr>
      <th>d2_D1_s12</th>
      <td>-18.352698</td>
      <td>2.234953e-30</td>
      <td>21</td>
      <td>756</td>
      <td>-3.439029</td>
      <td>-2.865371</td>
      <td>-2.568810</td>
    </tr>
    <tr>
      <th>d1_D2_s12</th>
      <td>-12.221559</td>
      <td>1.104309e-22</td>
      <td>20</td>
      <td>746</td>
      <td>-3.439146</td>
      <td>-2.865422</td>
      <td>-2.568837</td>
    </tr>
    <tr>
      <th>d2_D2_s12</th>
      <td>-15.080476</td>
      <td>8.468854e-28</td>
      <td>20</td>
      <td>745</td>
      <td>-3.439158</td>
      <td>-2.865427</td>
      <td>-2.568840</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># output indices as a list</span>
<span class="n">index_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="o">.</span><span class="n">tolist</span><span class="p">(</span><span class="n">summary_passed</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c1"># use the list as a condition to keep stationary time-series</span>
<span class="n">passed_series</span> <span class="o">=</span> <span class="n">diff_series</span><span class="p">[</span><span class="n">index_list</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the final set of time series </span>
<span class="c1"># NOTE: these plots are too small. Make a larger plot for each series to see things better!</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="n">passed_series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">passed_series</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/bf2fdee63014193db4dad0f3a9f51fb3dbda785e1834caade5912510512eaf83.png" src="../../_images/bf2fdee63014193db4dad0f3a9f51fb3dbda785e1834caade5912510512eaf83.png" />
</div>
</div>
</section>
<section id="select-candidates-for-orders-p-q-p-q">
<h4>Select candidates for orders <span class="math notranslate nohighlight">\(p, q, P, Q\)</span><a class="headerlink" href="#select-candidates-for-orders-p-q-p-q" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>We are going to make a script to extract canidates for the orders of the AR and MA component, both in the general and the seasonal part.</p></li>
<li><p>We will leverage the ACF and PACF functions.</p></li>
<li><p>So far, we looked at the <code class="docutils literal notranslate"><span class="pre">acf_plot</span></code> and <code class="docutils literal notranslate"><span class="pre">pacf_plot</span></code>.</p></li>
<li><p>Now we need to use <code class="docutils literal notranslate"><span class="pre">acf</span></code> and <code class="docutils literal notranslate"><span class="pre">pacf</span></code>.</p></li>
<li><p>We need to understand how these relate.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PACF</span><span class="p">,</span> <span class="n">PACF_ci</span> <span class="o">=</span> <span class="n">pacf</span><span class="p">(</span><span class="n">passed_series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

<span class="c1"># Plot PACF</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">PACF</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PACF&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">PACF_ci</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;95% Confidence Interval&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/952c7f31a2ab3831072525ce665be939e3a5bdfb884c6133bf3cb0a509bd02fe.png" src="../../_images/952c7f31a2ab3831072525ce665be939e3a5bdfb884c6133bf3cb0a509bd02fe.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># subtract the confidence interval from the PACF to center the CI in zero</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">29</span><span class="p">),</span> <span class="n">PACF_ci</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">PACF</span><span class="p">,</span> <span class="n">PACF_ci</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">PACF</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">29</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># Display the PACF as bars</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">29</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">PACF</span><span class="p">[:</span><span class="mi">29</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/fab02d71e81f73b46462d4f7bf88915f2da6885c18444d938f7fee8ddb03c181.png" src="../../_images/fab02d71e81f73b46462d4f7bf88915f2da6885c18444d938f7fee8ddb03c181.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_sp_p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> <span class="c1"># create an empty dataframe to store values of significant spikes in PACF plots</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">passed_series</span><span class="p">:</span>
    <span class="c1"># unpack the results into PACF and their CI</span>
    <span class="n">PACF</span><span class="p">,</span> <span class="n">PACF_ci</span> <span class="o">=</span> <span class="n">pacf</span><span class="p">(</span><span class="n">passed_series</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ywm&#39;</span><span class="p">)</span>
    
    <span class="c1"># subtract the upper and lower limits of CI by PACF to centre CI at zero</span>
    <span class="n">PACF_ci_ll</span> <span class="o">=</span> <span class="n">PACF_ci</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">PACF</span>
    <span class="n">PACF_ci_ul</span> <span class="o">=</span> <span class="n">PACF_ci</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">PACF</span>
        
    <span class="c1"># find positions of significant spikes representing possible value of p &amp; P</span>
    <span class="n">sp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PACF</span> <span class="o">&lt;</span> <span class="n">PACF_ci_ll</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PACF</span> <span class="o">&gt;</span> <span class="n">PACF_ci_ul</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="c1"># PACF values of the significant spikes</span>
    <span class="n">sp1_value</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">PACF</span><span class="p">[</span><span class="n">PACF</span> <span class="o">&lt;</span> <span class="n">PACF_ci_ll</span><span class="p">])</span>
    <span class="n">sp2_value</span> <span class="o">=</span> <span class="n">PACF</span><span class="p">[</span><span class="n">PACF</span> <span class="o">&gt;</span> <span class="n">PACF_ci_ul</span><span class="p">]</span>
    
    <span class="c1"># store values to dataframe</span>
    <span class="n">sp1_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">sp1_value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">sp1</span><span class="p">)</span>
    <span class="n">sp2_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">sp2_value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">sp2</span><span class="p">)</span>
    <span class="n">df_sp_p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">df_sp_p</span><span class="p">,</span> <span class="n">sp1_series</span><span class="p">,</span> <span class="n">sp2_series</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Sort the dataframe by index</span>
<span class="n">df_sp_p</span> <span class="o">=</span> <span class="n">df_sp_p</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="c1"># visualize sums of values of significant spikes in PACF plots ordered by lag</span>
<span class="n">df_sp_p</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Candidate AR Terms&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;nth lag&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Sum of PACF&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/228df703f8f9f963429885e1946d390ee68dd279b3c2362506ed23deb6ff1903.png" src="../../_images/228df703f8f9f963429885e1946d390ee68dd279b3c2362506ed23deb6ff1903.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_sp_q</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">passed_series</span><span class="p">:</span>
    <span class="c1"># unpack the results into ACF and their CI</span>
    <span class="n">ACF</span><span class="p">,</span> <span class="n">ACF_ci</span> <span class="o">=</span> <span class="n">acf</span><span class="p">(</span><span class="n">passed_series</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    
    <span class="c1"># subtract the upper and lower limits of CI by ACF to centre CI at zero</span>
    <span class="n">ACF_ci_ll</span> <span class="o">=</span> <span class="n">ACF_ci</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ACF</span>
    <span class="n">ACF_ci_ul</span> <span class="o">=</span> <span class="n">ACF_ci</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ACF</span>
    
    <span class="c1"># find positions of significant spikes representing possible value of q &amp; Q</span>
    <span class="n">sp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ACF</span> <span class="o">&lt;</span> <span class="n">ACF_ci_ll</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ACF</span> <span class="o">&gt;</span> <span class="n">ACF_ci_ul</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># ACF values of the significant spikes</span>
    <span class="n">sp1_value</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ACF</span><span class="p">[</span><span class="n">ACF</span> <span class="o">&lt;</span> <span class="n">ACF_ci_ll</span><span class="p">])</span>
    <span class="n">sp2_value</span> <span class="o">=</span> <span class="n">ACF</span><span class="p">[</span><span class="n">ACF</span> <span class="o">&gt;</span> <span class="n">ACF_ci_ul</span><span class="p">]</span>
    
    <span class="c1"># store values to dataframe</span>
    <span class="n">sp1_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">sp1_value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">sp1</span><span class="p">)</span>
    <span class="n">sp2_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">sp2_value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">sp2</span><span class="p">)</span>
    <span class="n">df_sp_q</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">df_sp_q</span><span class="p">,</span> <span class="n">sp1_series</span><span class="p">,</span> <span class="n">sp2_series</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Sort the dataframe by index</span>
<span class="n">df_sp_q</span> <span class="o">=</span> <span class="n">df_sp_q</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="c1"># visualize sums of values of significant spikes in ACF plots ordered by lags</span>
<span class="n">df_sp_q</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Candidate MA Terms&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;nth lag&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Sum of ACF&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2072a54fe4eefb9fcd5101cbb2c5ea64484939d572c889f8df04ccd4b8da5bdb.png" src="../../_images/2072a54fe4eefb9fcd5101cbb2c5ea64484939d572c889f8df04ccd4b8da5bdb.png" />
</div>
</div>
</section>
<section id="define-the-grid-of-hyperparameters-to-search">
<h4>Define the grid of hyperparameters to search<a class="headerlink" href="#define-the-grid-of-hyperparameters-to-search" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># possible values of the parameters</span>
<span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">P</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">D</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">Q</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="mi">12</span><span class="p">]</span>

<span class="c1"># create all combinations of possible values</span>
<span class="n">pdq</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">q</span><span class="p">))</span>
<span class="n">PDQm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of total combinations: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pdq</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">PDQm</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of total combinations: 144
</pre></div>
</div>
</div>
</div>
</section>
<section id="train-the-models">
<h4>Train the models<a class="headerlink" href="#train-the-models" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>We defined a function that takes every parameter configuration and trains a model.</p></li>
<li><p>For each model, we save the MSE, MAPE, AIC and BIC.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">SARIMA_grid</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">seasonal_order</span><span class="p">):</span>

    <span class="c1"># create an empty list to store values</span>
    <span class="n">model_info</span> <span class="o">=</span> <span class="p">[]</span>
       
    <span class="c1">#fit the model</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">seasonal_order</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">model_fit</span> <span class="o">=</span> <span class="n">SARIMAX</span><span class="p">(</span><span class="n">endog</span><span class="o">=</span><span class="n">endog</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">seasonal_order</span><span class="o">=</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">predict</span> <span class="o">=</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">predict</span><span class="p">()</span>
            
                <span class="c1"># calculate evaluation metrics: MAPE, RMSE, AIC &amp; BIC</span>
                <span class="n">MAPE</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">((</span><span class="n">endog</span><span class="o">-</span><span class="n">predict</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="p">(</span><span class="n">endog</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">MSE</span> <span class="o">=</span> <span class="n">mse</span><span class="p">(</span><span class="n">endog</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">predict</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">AIC</span> <span class="o">=</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">aic</span>
                <span class="n">BIC</span> <span class="o">=</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">bic</span>
            
                <span class="c1"># save order, seasonal order &amp; evaluation metrics</span>
                <span class="n">model_info</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">MAPE</span><span class="p">,</span> <span class="n">MSE</span><span class="p">,</span> <span class="n">AIC</span><span class="p">,</span> <span class="n">BIC</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
                
    <span class="c1"># create a dataframe to store info of all models</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="s2">&quot;seasonal_order&quot;</span><span class="p">,</span> <span class="s2">&quot;MAPE&quot;</span><span class="p">,</span> <span class="s2">&quot;MSE&quot;</span><span class="p">,</span> <span class="s2">&quot;AIC&quot;</span><span class="p">,</span> <span class="s2">&quot;BIC&quot;</span><span class="p">]</span>
    <span class="n">model_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">model_info</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model_info</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create train-test-split</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">monthly_temp</span><span class="p">)</span><span class="o">*</span><span class="mf">0.9</span><span class="p">)]</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">monthly_temp</span><span class="p">)</span><span class="o">*</span><span class="mf">0.9</span><span class="p">):]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># fit all combinations into the model</span>
<span class="n">model_info</span> <span class="o">=</span> <span class="n">SARIMA_grid</span><span class="p">(</span><span class="n">endog</span><span class="o">=</span><span class="n">train</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">pdq</span><span class="p">,</span> <span class="n">seasonal_order</span><span class="o">=</span><span class="n">PDQm</span><span class="p">)</span>

<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;time required: </span><span class="si">{</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  0%|                                                                                                                                                                       | 0/12 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  8%|█████████████▎                                                                                                                                                 | 1/12 [00:04&lt;00:47,  4.34s/it]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 17%|██████████████████████████▌                                                                                                                                    | 2/12 [00:10&lt;00:55,  5.51s/it]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 25%|███████████████████████████████████████▊                                                                                                                       | 3/12 [00:18&lt;00:58,  6.53s/it]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 33%|█████████████████████████████████████████████████████                                                                                                          | 4/12 [00:27&lt;00:59,  7.43s/it]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 42%|██████████████████████████████████████████████████████████████████▎                                                                                            | 5/12 [00:34&lt;00:51,  7.30s/it]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 50%|███████████████████████████████████████████████████████████████████████████████▌                                                                               | 6/12 [00:43&lt;00:48,  8.08s/it]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 58%|████████████████████████████████████████████████████████████████████████████████████████████▊                                                                  | 7/12 [00:55&lt;00:46,  9.40s/it]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 67%|██████████████████████████████████████████████████████████████████████████████████████████████████████████                                                     | 8/12 [01:08&lt;00:41, 10.30s/it]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 75%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▎                                       | 9/12 [01:19&lt;00:31, 10.51s/it]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 83%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▋                          | 10/12 [01:32&lt;00:22, 11.28s/it]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 92%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████▊             | 11/12 [01:45&lt;00:11, 11.98s/it]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12/12 [02:02&lt;00:00, 13.36s/it]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12/12 [02:02&lt;00:00, 10.19s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>time required: 122.2824649810791
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="analyze-the-results">
<h4>Analyze the results<a class="headerlink" href="#analyze-the-results" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Show the 10 best models according to the performance (MSE, MAPE) and model complexity (AIC, BIC)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 10 least MAPE models</span>
<span class="n">least_MAPE</span> <span class="o">=</span> <span class="n">model_info</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;MAPE&quot;</span><span class="p">)</span>
<span class="n">least_MAPE</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>order</th>
      <th>seasonal_order</th>
      <th>MAPE</th>
      <th>MSE</th>
      <th>AIC</th>
      <th>BIC</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>139</th>
      <td>(3, 1, 2)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.069034</td>
      <td>16.777194</td>
      <td>3860.356487</td>
      <td>3896.753693</td>
    </tr>
    <tr>
      <th>44</th>
      <td>(1, 1, 2)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.069051</td>
      <td>16.774448</td>
      <td>3855.637193</td>
      <td>3882.935097</td>
    </tr>
    <tr>
      <th>127</th>
      <td>(3, 1, 1)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.069080</td>
      <td>16.741029</td>
      <td>3856.095364</td>
      <td>3887.942919</td>
    </tr>
    <tr>
      <th>133</th>
      <td>(3, 1, 2)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.069123</td>
      <td>16.791367</td>
      <td>3859.566950</td>
      <td>3891.414505</td>
    </tr>
    <tr>
      <th>79</th>
      <td>(2, 1, 1)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.069124</td>
      <td>16.802771</td>
      <td>3857.201298</td>
      <td>3884.499203</td>
    </tr>
    <tr>
      <th>38</th>
      <td>(1, 1, 2)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.069130</td>
      <td>16.781108</td>
      <td>3854.502301</td>
      <td>3877.250555</td>
    </tr>
    <tr>
      <th>121</th>
      <td>(3, 1, 1)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.069167</td>
      <td>16.746322</td>
      <td>3854.844883</td>
      <td>3882.142788</td>
    </tr>
    <tr>
      <th>91</th>
      <td>(2, 1, 2)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.069172</td>
      <td>16.805174</td>
      <td>3860.077583</td>
      <td>3891.925138</td>
    </tr>
    <tr>
      <th>74</th>
      <td>(2, 1, 1)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.069203</td>
      <td>16.811211</td>
      <td>3856.176478</td>
      <td>3878.924732</td>
    </tr>
    <tr>
      <th>32</th>
      <td>(1, 1, 1)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.069219</td>
      <td>16.826987</td>
      <td>3856.770616</td>
      <td>3879.518869</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 10 least MSE models</span>
<span class="n">least_MSE</span> <span class="o">=</span> <span class="n">model_info</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;MSE&quot;</span><span class="p">)</span>
<span class="n">least_MSE</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>order</th>
      <th>seasonal_order</th>
      <th>MAPE</th>
      <th>MSE</th>
      <th>AIC</th>
      <th>BIC</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>127</th>
      <td>(3, 1, 1)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.069080</td>
      <td>16.741029</td>
      <td>3856.095364</td>
      <td>3887.942919</td>
    </tr>
    <tr>
      <th>121</th>
      <td>(3, 1, 1)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.069167</td>
      <td>16.746322</td>
      <td>3854.844883</td>
      <td>3882.142788</td>
    </tr>
    <tr>
      <th>44</th>
      <td>(1, 1, 2)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.069051</td>
      <td>16.774448</td>
      <td>3855.637193</td>
      <td>3882.935097</td>
    </tr>
    <tr>
      <th>139</th>
      <td>(3, 1, 2)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.069034</td>
      <td>16.777194</td>
      <td>3860.356487</td>
      <td>3896.753693</td>
    </tr>
    <tr>
      <th>38</th>
      <td>(1, 1, 2)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.069130</td>
      <td>16.781108</td>
      <td>3854.502301</td>
      <td>3877.250555</td>
    </tr>
    <tr>
      <th>133</th>
      <td>(3, 1, 2)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.069123</td>
      <td>16.791367</td>
      <td>3859.566950</td>
      <td>3891.414505</td>
    </tr>
    <tr>
      <th>79</th>
      <td>(2, 1, 1)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.069124</td>
      <td>16.802771</td>
      <td>3857.201298</td>
      <td>3884.499203</td>
    </tr>
    <tr>
      <th>91</th>
      <td>(2, 1, 2)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.069172</td>
      <td>16.805174</td>
      <td>3860.077583</td>
      <td>3891.925138</td>
    </tr>
    <tr>
      <th>74</th>
      <td>(2, 1, 1)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.069203</td>
      <td>16.811211</td>
      <td>3856.176478</td>
      <td>3878.924732</td>
    </tr>
    <tr>
      <th>85</th>
      <td>(2, 1, 2)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.069289</td>
      <td>16.825129</td>
      <td>3859.565057</td>
      <td>3886.862961</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 10 least AIC models</span>
<span class="n">least_AIC</span> <span class="o">=</span> <span class="n">model_info</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;AIC&quot;</span><span class="p">)</span>
<span class="n">least_AIC</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>order</th>
      <th>seasonal_order</th>
      <th>MAPE</th>
      <th>MSE</th>
      <th>AIC</th>
      <th>BIC</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3</th>
      <td>(1, 0, 1)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.080283</td>
      <td>61.491561</td>
      <td>3846.181890</td>
      <td>3864.386212</td>
    </tr>
    <tr>
      <th>9</th>
      <td>(1, 0, 1)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.080153</td>
      <td>61.471329</td>
      <td>3846.879649</td>
      <td>3869.635051</td>
    </tr>
    <tr>
      <th>15</th>
      <td>(1, 0, 2)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.080286</td>
      <td>61.482998</td>
      <td>3847.914835</td>
      <td>3870.670236</td>
    </tr>
    <tr>
      <th>50</th>
      <td>(2, 0, 1)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.080283</td>
      <td>61.485310</td>
      <td>3847.985625</td>
      <td>3870.741026</td>
    </tr>
    <tr>
      <th>97</th>
      <td>(3, 0, 1)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.080295</td>
      <td>61.449767</td>
      <td>3848.292676</td>
      <td>3875.599158</td>
    </tr>
    <tr>
      <th>20</th>
      <td>(1, 0, 2)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.080146</td>
      <td>61.461761</td>
      <td>3848.568559</td>
      <td>3875.875041</td>
    </tr>
    <tr>
      <th>56</th>
      <td>(2, 0, 1)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.080145</td>
      <td>61.464318</td>
      <td>3848.650344</td>
      <td>3875.956826</td>
    </tr>
    <tr>
      <th>115</th>
      <td>(3, 0, 2)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.080086</td>
      <td>61.401375</td>
      <td>3849.068660</td>
      <td>3885.477303</td>
    </tr>
    <tr>
      <th>103</th>
      <td>(3, 0, 1)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.080096</td>
      <td>61.430629</td>
      <td>3849.069448</td>
      <td>3880.927010</td>
    </tr>
    <tr>
      <th>62</th>
      <td>(2, 0, 2)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.080282</td>
      <td>61.469825</td>
      <td>3849.361800</td>
      <td>3876.668282</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 10 least BIC models</span>
<span class="n">least_BIC</span> <span class="o">=</span> <span class="n">model_info</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;BIC&quot;</span><span class="p">)</span>
<span class="n">least_BIC</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>order</th>
      <th>seasonal_order</th>
      <th>MAPE</th>
      <th>MSE</th>
      <th>AIC</th>
      <th>BIC</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3</th>
      <td>(1, 0, 1)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.080283</td>
      <td>61.491561</td>
      <td>3846.181890</td>
      <td>3864.386212</td>
    </tr>
    <tr>
      <th>9</th>
      <td>(1, 0, 1)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.080153</td>
      <td>61.471329</td>
      <td>3846.879649</td>
      <td>3869.635051</td>
    </tr>
    <tr>
      <th>15</th>
      <td>(1, 0, 2)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.080286</td>
      <td>61.482998</td>
      <td>3847.914835</td>
      <td>3870.670236</td>
    </tr>
    <tr>
      <th>50</th>
      <td>(2, 0, 1)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.080283</td>
      <td>61.485310</td>
      <td>3847.985625</td>
      <td>3870.741026</td>
    </tr>
    <tr>
      <th>26</th>
      <td>(1, 1, 1)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.069317</td>
      <td>16.836791</td>
      <td>3855.817196</td>
      <td>3874.015799</td>
    </tr>
    <tr>
      <th>97</th>
      <td>(3, 0, 1)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.080295</td>
      <td>61.449767</td>
      <td>3848.292676</td>
      <td>3875.599158</td>
    </tr>
    <tr>
      <th>20</th>
      <td>(1, 0, 2)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.080146</td>
      <td>61.461761</td>
      <td>3848.568559</td>
      <td>3875.875041</td>
    </tr>
    <tr>
      <th>56</th>
      <td>(2, 0, 1)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.080145</td>
      <td>61.464318</td>
      <td>3848.650344</td>
      <td>3875.956826</td>
    </tr>
    <tr>
      <th>62</th>
      <td>(2, 0, 2)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.080282</td>
      <td>61.469825</td>
      <td>3849.361800</td>
      <td>3876.668282</td>
    </tr>
    <tr>
      <th>38</th>
      <td>(1, 1, 2)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.069130</td>
      <td>16.781108</td>
      <td>3854.502301</td>
      <td>3877.250555</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>We can check if there are overlaps between the 4 different groups using the <code class="docutils literal notranslate"><span class="pre">set</span></code> function</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="n">least_MAPE</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">least_MSE</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{38, 44, 74, 79, 91, 121, 127, 133, 139}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="n">least_AIC</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">least_BIC</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{3, 9, 15, 20, 50, 56, 62, 97}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span><span class="p">(</span><span class="n">least_MSE</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">least_AIC</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>set()
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Show the top model according to each metric</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># the best model by each metric</span>
<span class="n">L1</span> <span class="o">=</span> <span class="n">model_info</span><span class="p">[</span><span class="n">model_info</span><span class="o">.</span><span class="n">MAPE</span> <span class="o">==</span> <span class="n">model_info</span><span class="o">.</span><span class="n">MAPE</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span>
<span class="n">L2</span> <span class="o">=</span> <span class="n">model_info</span><span class="p">[</span><span class="n">model_info</span><span class="o">.</span><span class="n">MSE</span> <span class="o">==</span> <span class="n">model_info</span><span class="o">.</span><span class="n">MSE</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span>
<span class="n">L3</span> <span class="o">=</span> <span class="n">model_info</span><span class="p">[</span><span class="n">model_info</span><span class="o">.</span><span class="n">AIC</span> <span class="o">==</span> <span class="n">model_info</span><span class="o">.</span><span class="n">AIC</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span>
<span class="n">L4</span> <span class="o">=</span> <span class="n">model_info</span><span class="p">[</span><span class="n">model_info</span><span class="o">.</span><span class="n">BIC</span> <span class="o">==</span> <span class="n">model_info</span><span class="o">.</span><span class="n">BIC</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span>

<span class="n">best_models</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">L1</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">L3</span><span class="p">,</span> <span class="n">L4</span><span class="p">))</span>
<span class="n">best_models</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>order</th>
      <th>seasonal_order</th>
      <th>MAPE</th>
      <th>MSE</th>
      <th>AIC</th>
      <th>BIC</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>139</th>
      <td>(3, 1, 2)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.069034</td>
      <td>16.777194</td>
      <td>3860.356487</td>
      <td>3896.753693</td>
    </tr>
    <tr>
      <th>127</th>
      <td>(3, 1, 1)</td>
      <td>(1, 1, 1, 12)</td>
      <td>0.069080</td>
      <td>16.741029</td>
      <td>3856.095364</td>
      <td>3887.942919</td>
    </tr>
    <tr>
      <th>3</th>
      <td>(1, 0, 1)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.080283</td>
      <td>61.491561</td>
      <td>3846.181890</td>
      <td>3864.386212</td>
    </tr>
    <tr>
      <th>3</th>
      <td>(1, 0, 1)</td>
      <td>(0, 1, 1, 12)</td>
      <td>0.080283</td>
      <td>61.491561</td>
      <td>3846.181890</td>
      <td>3864.386212</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="compute-performance-on-the-test-set">
<h4>Compute performance on the test set<a class="headerlink" href="#compute-performance-on-the-test-set" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Take the best models, compute the predictions and evaluate their performance in terms of MAPE on the w.r.t. test data.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Take the parameters of the best models</span>
<span class="n">ord_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">best_models</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">best_models</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<span class="n">s_ord_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">best_models</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">best_models</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<span class="n">preds</span><span class="p">,</span> <span class="n">ci_low</span><span class="p">,</span> <span class="n">ci_up</span><span class="p">,</span> <span class="n">MAPE_test</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="c1"># Fit the models and compute the forecasts</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">model_fit</span> <span class="o">=</span> <span class="n">SARIMAX</span><span class="p">(</span><span class="n">endog</span><span class="o">=</span><span class="n">train</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">ord_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                        <span class="n">seasonal_order</span><span class="o">=</span><span class="n">s_ord_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Fit the model</span>
    <span class="n">pred_summary</span> <span class="o">=</span> <span class="n">model_fit</span><span class="o">.</span><span class="n">get_prediction</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                                            <span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">summary_frame</span><span class="p">()</span> <span class="c1"># Compute preds</span>
    <span class="c1"># Store results</span>
    <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred_summary</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span>
    <span class="n">ci_low</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred_summary</span><span class="p">[</span><span class="s1">&#39;mean_ci_lower&#39;</span><span class="p">][</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
    <span class="n">ci_up</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred_summary</span><span class="p">[</span><span class="s1">&#39;mean_ci_upper&#39;</span><span class="p">][</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
    <span class="n">MAPE_test</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">abs</span><span class="p">((</span><span class="n">test</span><span class="o">-</span><span class="n">pred_summary</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">test</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># visualize the results of the fitted models</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                        <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Least MAPE Model </span><span class="si">{</span><span class="n">ord_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> x </span><span class="si">{</span><span class="n">s_ord_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
          <span class="sa">f</span><span class="s1">&#39;Least MSE Model </span><span class="si">{</span><span class="n">ord_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> x </span><span class="si">{</span><span class="n">s_ord_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
          <span class="sa">f</span><span class="s1">&#39;Least AIC Model </span><span class="si">{</span><span class="n">ord_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1"> x </span><span class="si">{</span><span class="n">s_ord_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
          <span class="sa">f</span><span class="s1">&#39;Least BIC Model </span><span class="si">{</span><span class="n">ord_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s1"> x </span><span class="si">{</span><span class="n">s_ord_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">monthly_temp</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prediction&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; -- MAPE test: </span><span class="si">{</span><span class="n">MAPE_test</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="n">ci_low</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">y2</span><span class="o">=</span><span class="n">ci_up</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">monthly_temp</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">120</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="n">monthly_temp</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/79052a87bc11f49b6240ed1700d391936912ae4f8b9fe8901cf59221148774fa.png" src="../../_images/79052a87bc11f49b6240ed1700d391936912ae4f8b9fe8901cf59221148774fa.png" />
</div>
</div>
</section>
</section>
</section>
<hr class="docutils" />
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Autoregressive Moving Average (ARMA) models.</p></li>
<li><p>Autoregressive Integrated Moving Average (ARIMA) models.</p></li>
<li><p>SARIMA models (ARIMA model for data with seasonality).</p></li>
<li><p>Selecting the best model.</p></li>
</ol>
</section>
<hr class="docutils" />
<section id="exercise">
<h2>Exercise<a class="headerlink" href="#exercise" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Look at sensor data that tracks atmospheric CO2 from continuous air samples at Mauna Loa Observatory in Hawaii. This data includes CO2 samples from MAR 1958 to DEC 1980.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">co2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;https://zenodo.org/records/10951538/files/arima_co2.csv?download=1&#39;</span><span class="p">,</span> 
                  <span class="n">header</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                  <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">,</span> <span class="s1">&#39;co2&#39;</span><span class="p">],</span>
                  <span class="n">skipfooter</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># convert the column idx into a datetime object and set it as the index</span>
<span class="n">co2</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">co2</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">])</span>
<span class="n">co2</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;idx&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Rmove the name &quot;idx&quot; from the index column</span>
<span class="n">co2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">co2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>co2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1965-01-01</th>
      <td>319.32</td>
    </tr>
    <tr>
      <th>1965-02-01</th>
      <td>320.36</td>
    </tr>
    <tr>
      <th>1965-03-01</th>
      <td>320.82</td>
    </tr>
    <tr>
      <th>1965-04-01</th>
      <td>322.06</td>
    </tr>
    <tr>
      <th>1965-05-01</th>
      <td>322.17</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>1980-08-01</th>
      <td>337.19</td>
    </tr>
    <tr>
      <th>1980-09-01</th>
      <td>335.49</td>
    </tr>
    <tr>
      <th>1980-10-01</th>
      <td>336.63</td>
    </tr>
    <tr>
      <th>1980-11-01</th>
      <td>337.74</td>
    </tr>
    <tr>
      <th>1980-12-01</th>
      <td>338.36</td>
    </tr>
  </tbody>
</table>
<p>192 rows × 1 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>Determine the presence of main trend and seasonality in the data.</p></li>
<li><p>Determine if the data are stationary.</p></li>
<li><p>Split the data in train (90%) and test (10%)</p></li>
<li><p>Find a set of SARIMAX candidate models by looking at the ACF and PACF</p></li>
<li><p>Perform a grid search on the model candidates</p></li>
<li><p>Select the best models, based on performance metrics, model complexity, and normality of the residuals.</p></li>
<li><p>Compare the best model you found with the one from autoarima</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/05"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../04/ar-ma.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">AR-MA</p>
      </div>
    </a>
    <a class="right-next"
       href="../06/unit-root-hurst.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Unit root test and Hurst exponent</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#arma">ARMA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#time-series-modeling-process">Time Series Modeling Process</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data">Load data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#arma-model-stages">ARMA Model Stages</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-identification">Model Identification</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#determine-stationarity">Determine Stationarity</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#determine-seasonality">Determine Seasonality</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-the-main-seasonality">Remove the main seasonality</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#identifying-p-and-q">Identifying <span class="math notranslate nohighlight">\(p\)</span> and <span class="math notranslate nohighlight">\(q\)</span></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-estimation">Model estimation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#arma-model-validation">ARMA Model Validation</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visual-inspection">Visual inspection</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#statistical-tests">Statistical tests</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#arma-model-predictions">ARMA Model Predictions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#arima-model">ARIMA Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sarima">SARIMA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#autoarima">AutoARIMA</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#autoarima-or-not-autoarima">AutoARIMA or not AutoARIMA?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#grid-search">Grid Search</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction-performance">Prediction performance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-complexity">Model complexity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#restricting-the-search-with-exploratory-data-analysis-eda">Restricting the search with Exploratory Data Analysis (EDA)</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#selecting-the-candidates-for-differentiation">Selecting the candidates for differentiation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#filter-out-non-stationary-candidates">Filter-out non-stationary candidates</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#select-candidates-for-orders-p-q-p-q">Select candidates for orders <span class="math notranslate nohighlight">\(p, q, P, Q\)</span></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-the-grid-of-hyperparameters-to-search">Define the grid of hyperparameters to search</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#train-the-models">Train the models</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#analyze-the-results">Analyze the results</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-performance-on-the-test-set">Compute performance on the test set</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise">Exercise</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Filippo Maria Bianchi
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>